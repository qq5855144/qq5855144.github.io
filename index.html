<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Mgr</title>

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="favicon.ico">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* 基础样式 */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --glass-blur: blur(12px);
            --primary-color: #4f46e5;
            --text-primary: #1e293b;
            --text-secondary: #475569;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 毛玻璃效果 */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 16px;
        }

        /* 按钮样式 */
        .glass-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
        }

        .glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.2);
            background: rgba(255, 255, 255, 0.3);
        }

        .glass-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.1);
        }

        .glass-btn-primary {
            background: rgba(79, 70, 229, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-btn-primary:hover {
            background: rgba(79, 70, 229, 0.9);
        }

        /* 输入框样式 */
        .glass-input {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            width: 100%;
        }

        .glass-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
            background: rgba(255, 255, 255, 0.3);
        }

        .glass-input::placeholder {
            color: rgba(71, 85, 105, 0.6);
        }

        /* 页头 */
        .app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    /* 修改为与文件列表相同的毛玻璃效果 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    padding: 1rem;
}


        .app-content {
            flex: 1;
            margin-top: 80px; /* 页头高度 */
            margin-bottom: 80px; /* 页脚高度 */
            padding: 1rem;
            overflow-y: auto;
        }
       /* 页脚 */
       .app-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    /* 修改为与文件列表相同的毛玻璃效果 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    padding: 1rem;
}


        /* 文件列表项 */
        .file-item {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.1);
        }

        .file-item.selected {
            background: rgba(79, 70, 229, 0.2);
            border-color: rgba(79, 70, 229, 0.3);
        }

        /* 编辑器样式 */
        #editor-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            background: white;
            display: none;
            flex-direction: column;
        }

        .editor-header {
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .editor-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .editor-btn-save {
            background: #4f46e5;
            color: white;
            border: none;
        }

        .editor-btn-save:hover {
            background: #4338ca;
        }

        .editor-btn-close {
            background: #e5e7eb;
            color: #4b5563;
            border: none;
        }

        .editor-btn-close:hover {
            background: #d1d5db;
        }

        #editor {
            flex: 1;
            min-height: 0;
        }

        /* 隐藏类 */
        .hidden {
            display: none !important;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-header {
                padding: 0.75rem;
            }

            .app-content {
                margin-top: 70px;
                margin-bottom: 70px;
                padding: 0.75rem;
            }

            .app-footer {
                padding: 0.75rem;
            }

            .editor-status-bar {
                display: none;
            }

            .editor-header {
                padding: 10px 15px;
                flex-wrap: wrap;
            }

            .editor-header h2 {
                font-size: 16px;
                max-width: 60%;
            }

            .editor-actions {
                flex-wrap: wrap;
                gap: 5px;
            }

            .editor-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 0.5rem;
            }

            .app-content {
                margin-top: 60px;
                margin-bottom: 60px;
                padding: 0.5rem;
            }

            .app-footer {
                padding: 0.5rem;
            }
        }

        /* 文件类型图标 */
        .file-icon {
            margin-right: 12px;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.1));
        }
        
        .folder-icon {
            color: #f59e0b;
        }
        
        .archive-icon {
            color: #6366f1;
        }
        
        .image-icon {
            color: #ec4899;
        }
        
        .code-icon {
            color: #3b82f6;
        }
        
        .text-icon {
            color: #64748b;
        }
        
        /* 工具栏 */
        .toolbar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 24px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .toolbar.hidden {
            transform: translateY(100px);
            opacity: 0;
            pointer-events: none;
        }
        
        /* 对话框 */
        .dialog-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 999;
        }

        .dialog-content {
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 10px; 
            padding: 14px 16px; 
            width: 85%;
            max-width: 340px; 
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        /* 标题 */
        .dialog-content h3 {
            font-size: 1.1rem;
            margin-bottom: 0.6rem;
        }

        /* 输入框 */
        .dialog-input {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 5px;
            padding: 8px 12px; 
            font-size: 0.85rem;
            height: 36px; 
            margin-bottom: 0.6rem;
        }

        /* 按钮容器 */
        .dialog-buttons {
            margin-top: 0.8rem;
            gap: 6px; 
        }

        /* 按钮 */
        .dialog-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 5px;
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            
            .editor-status-bar{
                display: none;
            }
            
            .dialog-content {
                padding: 12px 14px;
                max-width: 300px;
            }
            
            .dialog-input {
                padding: 7px 10px;
                height: 34px;
            }
            
            .dialog-btn {
                padding: 5px 10px;
            }
        }
        
        /* 加载动画 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* 面包屑导航 */
        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .breadcrumb-item:hover {
            color: var(--primary-color);
        }
        
        .breadcrumb-separator {
            margin: 0 8px;
            color: var(--text-secondary);
        }
        
        /* 上下文菜单 */
        .context-menu {
    position: fixed; /* 改为固定定位 */
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    overflow: hidden;
    transform: scale(0.95);
    opacity: 0;
    transition: transform 0.2s ease, opacity 0.2s ease;
    pointer-events: none;
    max-height: 80vh; /* 限制最大高度 */
    overflow-y: auto; /* 添加滚动条 */
}

        
        .context-menu.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .context-menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }
        
        /* 批量操作工具栏 */
        .batch-toolbar {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            background: rgba(79, 70, 229, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            border-radius: 24px;
            padding: 8px 16px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1000;
            margin: 0 auto;
            width: fit-content;
            max-width: 90%;
        }
        
        .batch-toolbar.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .batch-toolbar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        
        .batch-toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .batch-toolbar-btn i {
            margin-right: 6px;
        }
        
        .batch-count {
            margin-right: 12px;
            display: flex;
            align-items: center;
        }
        
        /* 用户菜单 */
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-menu-btn {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .user-menu-content {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            border-radius: 12px;
            min-width: 180px;
            z-index: 1100;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            pointer-events: none;
           
        }
        
        .user-menu-content.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .user-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .user-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .user-menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .user-menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }
        
        /* 响应式调整 */
        @media (max-width: 640px) {
            .glass {
                border-radius: 12px;
            }
            
            .file-item {
                padding: 12px;
            }
            
            .toolbar {
                padding: 8px;
                border-radius: 20px;
            }
            
            .breadcrumb {
                font-size: 14px;
            }
            
            .batch-toolbar {
                bottom: 70px;
                padding: 6px 12px;
            }
            
            .batch-toolbar-btn {
                padding: 6px 8px;
                font-size: 14px;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.7);
        }
        
        /* 构建状态提示 */
        .build-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .build-status.hidden {
            transform: translateY(-20px);
            opacity: 0;
            pointer-events: none;
        }
        
        /* 构建APP菜单项样式 */
        .context-build-app {
            color: #3b82f6; /* 蓝色表示操作项 */
        }
        .workflow-icon {
    color: #8b5cf6; /* 紫色图标 */
}

/* 固定顶栏 */
  .top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    border-radius: 0;
    margin-bottom: 0 !important; 
    z-index: 1000; 
  }

  /* 路径容器样式 */
#path-container {
    min-width: 0; /* 允许内容溢出 */
    overflow-x: auto; /* 启用横向滚动 */
    scrollbar-width: thin; /* Firefox */
}

/* 隐藏滚动条（美观考虑） */
#path-container::-webkit-scrollbar {
    height: 4px; /* 设置滚动条高度 */
}

#path-container::-webkit-scrollbar-thumb {
    background-color: rgba(79, 70, 229, 0.3); /* 滚动条颜色 */
    border-radius: 2px; /* 圆角 */
}

#path-container::-webkit-scrollbar-track {
    background: transparent; /* 透明背景 */
}

/* 防止路径换行 */
.breadcrumb {
    display: flex;
    align-items: center;
    flex-wrap: nowrap; /* 禁止换行 */
    white-space: nowrap; /* 确保文本不换行 */
}

/* 包屑导航栏中的GitHub图标 */
.breadcrumb-item i.fab.fa-github {
    font-size: 20px;       
    color: #4f46e5;        
    transition: all 0.3s;  
}

/* 移动设备适配 */
  @media (max-width: 768px) {
    .editor-status-bar{
        display: none;
    }

    /* 编辑器容器调整 */
    #editor-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      display: flex;
      flex-direction: column;
    }
    
    /* 编辑器头部调整 */
    .editor-header {
      padding: 10px 15px;
      flex-wrap: wrap;
    }
    
    .editor-header h2 {
      font-size: 16px;
      max-width: 60%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* 编辑器按钮调整 */
    .editor-actions {
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .editor-btn {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    /* 状态栏调整 */
    .editor-status-bar {
      flex-direction: column;
      align-items: flex-start;
      padding: 8px;
      font-size: 12px;
    }
    
    .editor-status-item {
      margin-bottom: 4px;
    }
    
    /* 编辑器内容区域调整 */
    #editor {
      font-size: 10px !important; /* 增大字体 */
    }
    
    /* 添加移动设备专用工具栏 */
    .mobile-editor-toolbar {
      display: flex;
      background: #f5f5f5;
      border-top: 1px solid #ddd;
      padding: 8px;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
    
    .mobile-toolbar-btn {
      flex: 1;
      padding: 8px;
      margin: 0 2px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }
  }
  
  /* 图片预览样式 */
.image-preview-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.image-preview-content {
    position: relative;
    z-index: 1;
    max-width: 90%;
    max-height: 90%;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.image-preview-header {
    padding: 12px 16px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.image-preview-title {
    font-weight: 600;
    font-size: 16px;
    color: #343a40;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 10px;
}

.image-preview-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #6c757d;
    transition: color 0.2s;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.image-preview-close:hover {
    color: #495057;
    background-color: #e9ecef;
}

.image-preview-body {
    padding: 20px;
    overflow: auto;
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
    min-width: 300px;
}

.image-preview-body img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 6px;
}

.image-preview-footer {
    padding: 12px 16px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}

/* 背景切换按钮组 */
.background-toggle {
    display: flex;
    gap: 6px;
}

.btn-bg-light, .btn-bg-dark, .btn-bg-grid {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
}

.btn-bg-light:hover, .btn-bg-dark:hover, .btn-bg-grid:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-bg-light:active, .btn-bg-dark:active, .btn-bg-grid:active {
    transform: translateY(0);
}

/* 操作按钮 */
.preview-action-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: none;
    background: #4f46e5;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
}

.preview-action-btn:hover {
    background: #4338ca;
}

.preview-action-btn.secondary {
    background: #e9ecef;
    color: #495057;
}

.preview-action-btn.secondary:hover {
    background: #dee2e6;
}

/* 深色网格背景 */
.checkerboard-dark-bg {
    background-color: #333333;
    background-image: 
        linear-gradient(45deg, #444 25%, transparent 25%),
        linear-gradient(-45deg, #444 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #444 75%),
        linear-gradient(-45deg, transparent 75%, #444 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

/* 浅色网格背景 */
.checkerboard-bg {
    background-color: #ffffff;
    background-image: 
        linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
        linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

/* 纯色背景 */
.light-bg {
    background-color: #ffffff;
}

/* 响应式调整 */
@media (max-width: 640px) {
    .image-preview-content {
        max-width: 95%;
        max-height: 95%;
    }
    
    .image-preview-footer {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .background-toggle {
        order: 2;
        margin-top: 8px;
    }
    
    .preview-action-btn {
        padding: 6px 12px;
        font-size: 13px;
    }
}

/* 图片加载动画样式 */
.image-loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #64748b;
    font-size: 14px;
}

/* 图片预览样式 */
.image-preview-body img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 6px;
    transition: opacity 0.3s ease;
}
  
    </style>
</head>
<body>
    <!-- 认证界面 -->
    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="glass-panel p-8 w-full max-w-md mx-auto">
            <div class="text-center mb-8">
                <i class="fab fa-github text-5xl mb-4" style="color: var(--primary-color);"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">GitHub Mgr</h1>
                <p class="text-gray-600">使用您的 GitHub Token 登录</p>
            </div>
            
            <div class="mb-6">
                <input type="text" id="github-token" placeholder="输入您的 GitHub Token" 
                       class="glass-input mb-1">
                <p id="token-error" class="text-red-500 text-sm hidden"></p>
            </div>
            
            <button id="auth-btn" class="glass-btn glass-btn-primary w-full py-3 font-medium flex items-center justify-center">
                <span id="auth-btn-text">认证并继续</span>
                <i id="auth-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
            
            <div class="mt-8 text-sm text-gray-600">
                <p class="font-medium mb-2">如何获取 Token？</p>
                <ol class="list-decimal pl-5 space-y-1">
                    <li>登录 GitHub 账户</li>
                    <li>访问 <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-500 hover:underline">开发者设置</a></li>
                    <li>创建新的个人访问令牌</li>
                    <li>勾选 repo 权限</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- 主界面 -->
    <div id="main-screen" class="hidden flex flex-col min-h-screen">
        <!-- 页头 -->
        <header class="app-header">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <!-- 路径显示 -->
                <div id="path-container" class="flex-1 min-w-0 overflow-x-auto">
                    <div id="current-path" class="text-lg font-semibold">
                        <div class="breadcrumb whitespace-nowrap">
                            <div class="breadcrumb-item" onclick="loadRepositories()">
                                <i class="fab fa-github mr-1"></i>
                                <span>我的仓库</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 用户菜单 -->
                <div class="user-menu">
                    <div id="user-menu-btn" class="user-menu-btn glass-btn p-2">
                        <i class="fas fa-user-circle text-lg"></i>
                    </div>
                    <div id="user-menu-content" class="user-menu-content">
                        <div id="user-info" class="user-menu-item">
                            <i class="fas fa-user"></i>
                            <span id="username"></span>
                        </div>
                        <div class="user-menu-divider"></div>
                        <div id="logout-btn" class="user-menu-item">
                            <i class="fas fa-sign-out-alt text-red-500"></i>
                            <span class="text-red-500">退出登录</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 内容区 -->
        <main class="app-content">
            <div class="max-w-6xl mx-auto">
                <div id="loading" class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
                </div>
                
                <div id="file-list" class="grid gap-3 hidden">
                    <!-- 动态生成的文件列表 -->
                </div>
                
                <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 text-gray-500">
                    <i class="fas fa-folder-open text-5xl mb-4 opacity-50"></i>
                    <p class="text-lg">当前目录为空</p>
                </div>
            </div>
        </main>
        
        <!-- 页脚 -->
<footer class="app-footer">
    <div class="max-w-6xl mx-auto flex justify-center gap-3">        
        <button id="new-repo-btn" class="glass-btn p-3" title="新建仓库">
            <i class="fas fa-plus text-blue-500"></i>
        </button>
        <button id="fork-repo-btn" class="glass-btn p-3 hidden" title="复刻仓库">
            <i class="fas fa-code-branch text-purple-500"></i>
        </button>       
        <button id="new-folder-btn" class="glass-btn p-3 hidden" title="新建文件夹">
            <i class="fas fa-folder-plus text-amber-500"></i>
        </button>
        <button id="upload-btn" class="glass-btn p-3 hidden" title="上传文件">
            <i class="fas fa-upload text-violet-500"></i>
        </button>
        <button id="select-btn" class="glass-btn p-3 hidden" title="选择文件">
            <i class="fas fa-check-square text-blue-500"></i>
        </button>
    </div>
</footer>
        
        <!-- 批量操作工具栏 -->
        <div id="batch-toolbar" class="batch-toolbar">
            <div class="batch-count">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="selected-count">0</span> 已选
            </div>
            <button id="batch-download-btn" class="batch-toolbar-btn" title="下载选中文件">
                <i class="fas fa-download"></i>
                <span>下载</span>
            </button>
            <button id="batch-delete-btn" class="batch-toolbar-btn" title="删除选中文件">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </button>
            <button id="batch-cancel-btn" class="batch-toolbar-btn" title="取消选择">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- 编辑器容器 -->
    <div id="editor-container" class="fixed inset-0 z-[2000] hidden flex-col bg-white">
        <div class="editor-header">
            <h2 id="editor-filename"></h2>
            <div class="editor-actions">
                <button id="editor-save-btn" class="editor-btn editor-btn-save">保存</button>
                <button id="editor-close-btn" class="editor-btn editor-btn-close">关闭</button>
            </div>
        </div>
        <div id="editor"></div>
        <!-- 移动设备工具栏 -->
        <div class="mobile-editor-toolbar">
            <button class="mobile-toolbar-btn" id="mobile-save-btn">
                <i class="fas fa-save"></i> 保存
            </button>
            <button class="mobile-toolbar-btn" id="mobile-close-btn">
                <i class="fas fa-times"></i> 关闭
            </button>
            <button class="mobile-toolbar-btn" id="mobile-undo-btn">
                <i class="fas fa-undo"></i> 撤销
            </button>
            <button class="mobile-toolbar-btn" id="mobile-redo-btn">
                <i class="fas fa-redo"></i> 重做
            </button>
            <button class="mobile-toolbar-btn" id="mobile-search-btn">
                <i class="fas fa-search"></i> 搜索
            </button>
        </div>
        <div class="editor-status-bar">
            <div class="editor-status-item">
                <span id="editor-file-size"></span>
            </div>
            <div class="editor-status-item">
                <span id="editor-language"></span>
            </div>
        </div>
    </div>
    
    <!-- 操作提示 -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full opacity-0 transition-opacity duration-300 text-sm font-medium">
        <!-- 提示内容 -->
    </div>
    
    <!-- 确认对话框 -->
    <div id="confirm-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="confirm-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
            <h3 id="confirm-title" class="text-xl font-bold mb-2">确认删除</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">您确定要删除这个文件吗？此操作不可撤销。</p>
            <div id="confirm-buttons" class="flex justify-end gap-3">
                <button id="confirm-no" class="glass-btn px-4 py-2">取消</button>
                <button id="confirm-yes" class="glass-btn glass-btn-primary px-4 py-2">确认删除</button>
            </div>
        </div>
    </div>
    
    <!-- 新建文件夹对话框 -->
    <div id="new-folder-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="new-folder-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
            <h3 id="new-folder-title" class="text-xl font-bold mb-2">新建文件夹</h3>
            <input type="text" id="new-folder-name" placeholder="文件夹名称" class="glass-input mb-4">
            <div id="new-folder-buttons" class="flex justify-end gap-3">
                <button id="new-folder-cancel" class="glass-btn px-4 py-2">取消</button>
                <button id="new-folder-create" class="glass-btn glass-btn-primary px-4 py-2">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 新建仓库对话框 -->
<div id="new-repo-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="new-repo-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
        <h3 id="new-repo-title" class="text-xl font-bold mb-2">新建仓库</h3>
        <input type="text" id="new-repo-name" placeholder="仓库名称" class="glass-input mb-3">
        <input type="text" id="new-repo-desc" placeholder="仓库描述 (可选)" class="glass-input mb-3">
        <div class="flex items-center mb-4">
            <input type="checkbox" id="new-repo-private" class="mr-2">
            <label for="new-repo-private">私有仓库</label>
        </div>
        <div id="new-repo-buttons" class="flex justify-end gap-3">
            <button id="new-repo-cancel" class="glass-btn px-4 py-2">取消</button>
            <button id="new-repo-create" class="glass-btn glass-btn-primary px-4 py-2">创建</button>
        </div>
    </div>
</div>

<!-- 复刻仓库对话框 -->
<div id="fork-repo-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="fork-repo-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
        <h3 id="fork-repo-title" class="text-xl font-bold mb-2">复刻仓库</h3>
        <input type="text" id="fork-repo-url" placeholder="输入GitHub仓库URL" class="glass-input mb-4">
        <div id="fork-repo-buttons" class="flex justify-end gap-3">
            <button id="fork-repo-cancel" class="glass-btn px-4 py-2">取消</button>
            <button id="fork-repo-confirm" class="glass-btn glass-btn-primary px-4 py-2">复刻</button>
        </div>
    </div>
</div>

    <!-- 上传文件对话框 -->
    <div id="upload-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="upload-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
            <h3 id="upload-title" class="text-xl font-bold mb-2">上传文件</h3>
            <input type="file" id="file-input" class="glass-input mb-4" multiple>
            <div id="upload-buttons" class="flex justify-end gap-3">
                <button id="upload-cancel" class="glass-btn px-4 py-2">取消</button>
                <button id="upload-file" class="glass-btn glass-btn-primary px-4 py-2">上传</button>
            </div>
        </div>
    </div>
    
    <!-- 上下文菜单 -->
<div id="context-menu" class="context-menu">
    <div id="context-open" class="context-menu-item">
        <i class="fas fa-folder-open"></i>
        <span>打开</span>
    </div>
    <div class="context-menu-divider"></div>  
    
    <div id="context-copy-repo-link" class="context-menu-item">
        <i class="fas fa-link"></i>
        <span>复制仓库链接</span>
    </div>
   
    <div id="context-copy-site-link" class="context-menu-item hidden">
        <i class="fas fa-globe"></i>
        <span>复制网站链接</span>
    </div>
    
    <div id="context-rename-repo" class="context-menu-item">
        <i class="fas fa-edit"></i>
        <span>重命名仓库</span>
    </div>
    
    <div id="context-download" class="context-menu-item">
        <i class="fas fa-download"></i>
        <span>下载</span>
    </div>
          
    <div id="context-rename" class="context-menu-item">
        <i class="fas fa-edit"></i>
        <span>重命名</span>
    </div>
            
    <div id="context-copy-link" class="context-menu-item">
        <i class="fas fa-link"></i>
        <span>复制链接</span>
    </div>
            
    <div id="context-copy-proxy-link" class="context-menu-item">
        <i class="fas fa-share-alt"></i>
        <span>复制代理链接</span>
    </div>
            
    <!-- 仓库级菜单 -->
    <div id="context-download-source" class="context-menu-item">
        <i class="fas fa-download text-blue-500"></i>
        <span class="text-blue-500">下载源码</span>
    </div>
            
    <!-- 触发工作流 -->       
    <div id="context-build-app" class="context-menu-item context-build-app">
        <i class="fas fa-hammer"></i>
        <span>运行工作流</span>
    </div>                                  
    <!-- 添加部署网站选项 -->        
    <div id="context-enable-pages" class="context-menu-item">
        <i class="fas fa-globe text-green-500"></i>
        <span class="text-green-500">部署网站</span>
    </div>
        
     <div class="context-menu-divider"></div>       
    <div id="context-delete" class="context-menu-item">
        <i class="fas fa-trash text-red-500"></i>
        <span class="text-red-500">删除</span>
    </div>
</div>
    
    <!-- 添加部署网站配置对话框 -->
    <div id="static-site-dialog" class="fixed inset-0 z-50 dialog-overlay flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="static-site-content" class="dialog-content p-6 rounded-xl w-full max-w-md transform scale-90 transition-transform duration-300">
            <h3 id="static-site-title" class="text-xl font-bold mb-4">部署网站配置</h3>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium">分支</label>
                <select id="pages-branch" class="glass-input mb-1">
                    <option value="main">main</option>
                    <option value="master">master</option>
                    <option value="gh-pages">gh-pages</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium">目录</label>
                <select id="pages-folder" class="glass-input mb-1">
                    <option value="/">根目录</option>
                    <option value="/docs">docs 文件夹</option>
                </select>
            </div>
            
            <div id="pages-status" class="mb-4 hidden">
                <div class="flex items-center">
                    <i class="fas fa-circle text-green-500 mr-2"></i>
                    <span class="font-medium">网站已启用</span>
                </div>
                <div class="mt-2">
                    <span class="text-sm">访问地址: </span>
                    <a id="pages-url" href="#" target="_blank" class="text-blue-500 text-sm hover:underline"></a>
                </div>
            </div>
            
            <div id="static-site-buttons" class="flex justify-end gap-3">
                <button id="static-site-cancel" class="glass-btn px-4 py-2">取消</button>
                <button id="static-site-enable" class="glass-btn glass-btn-primary px-4 py-2">启用</button>
            </div>
        </div>
    </div>
    
    <!-- 新增构建状态提示 -->
    <div id="build-status" class="build-status glass-panel p-4 hidden">
        <div class="flex items-center mb-2">
            <i id="build-icon" class="fas fa-cog animate-spin text-blue-500 mr-2"></i>
            <h3 class="font-semibold">构建状态</h3>
            <button id="close-build-status" class="ml-auto text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="build-message" class="text-sm"></div>
        <div id="build-progress" class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-xs text-right mt-1">0%</div>
        </div>
    </div>
    
    
    <script>
       // ==================== 配置模块 ====================
const Config = {
    // 文本文件扩展名列表
    textFileExtensions: ['txt', 'js', 'jsx', 'ts', 'tsx', 'html', 'css', 'scss', 'less', 'json', 'xml', 'yml', 'yaml', 'md', 'ini', 'conf', 'cfg', 'env', 'gitignore', 'log', 'sh', 'bash', 'zsh', 'py', 'java', 'c', 'cpp', 'h', 'hpp', 'cs', 'go', 'rs', 'swift', 'kt', 'dart', 'lua', 'rb', 'pl', 'r', 'm', 'php'],

    // Monaco Editor语言映射
    languageMapping: {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'html': 'html',
        'css': 'css',
        'scss': 'scss',
        'less': 'less',
        'json': 'json',
        'xml': 'xml',
        'yml': 'yaml',
        'yaml': 'yaml',
        'md': 'markdown',
        'sh': 'shell',
        'bash': 'shell',
        'zsh': 'shell',
        'py': 'python',
        'java': 'java',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'c',
        'hpp': 'cpp',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'swift': 'swift',
        'kt': 'kotlin',
        'dart': 'dart',
        'lua': 'lua',
        'rb': 'ruby',
        'pl': 'perl',
        'r': 'r',
        'm': 'matlab',
        'php': 'php'
    },

    // 文件类型图标映射
    fileTypeIcons: {
        // 工作流文件
        yml: 'fas fa-gears workflow-icon',
        yaml: 'fas fa-gears workflow-icon',
        // 压缩文件
        zip: 'fas fa-file-archive archive-icon',
        rar: 'fas fa-file-archive archive-icon',
        '7z': 'fas fa-file-archive archive-icon',
        tar: 'fas fa-file-archive archive-icon',
        gz: 'fas fa-file-archive archive-icon',
        bz2: 'fas fa-file-archive archive-icon',
        xz: 'fas fa-file-archive archive-icon',
        lz: 'fas fa-file-archive archive-icon',
        dmg: 'fas fa-file-archive archive-icon',
        iso: 'fas fa-file-archive archive-icon',
        
        // 可执行文件
        exe: 'fas fa-file-code exe-icon',
        msi: 'fas fa-file-code exe-icon',
        app: 'fas fa-file-code exe-icon',
        apk: 'fas fa-file-code exe-icon',
        deb: 'fas fa-file-code exe-icon',
        rpm: 'fas fa-file-code exe-icon',
        bat: 'fas fa-file-code exe-icon',
        cmd: 'fas fa-file-code exe-icon',
        
        // 图片
        png: 'fas fa-file-image image-icon',
        jpg: 'fas fa-file-image image-icon',
        jpeg: 'fas fa-file-image image-icon',
        gif: 'fas fa-file-image image-icon',
        svg: 'fas fa-file-image image-icon',
        webp: 'fas fa-file-image image-icon',
        ico: 'fas fa-file-image image-icon',
        bmp: 'fas fa-file-image image-icon',
        tiff: 'fas fa-file-image image-icon',
        psd: 'fas fa-file-image image-icon',
        ai: 'fas fa-file-image image-icon',
        
        // 代码文件
        css: 'fas fa-file-code code-icon',
        scss: 'fas fa-file-code code-icon',
        less: 'fas fa-file-code code-icon',
        js: 'fas fa-file-code code-icon',
        jsx: 'fas fa-file-code code-icon',
        ts: 'fas fa-file-code code-icon',
        tsx: 'fas fa-file-code code-icon',
        json: 'fas fa-file-code code-icon',
        html: 'fas fa-file-code code-icon',
        htm: 'fas fa-file-code code-icon',
        xml: 'fas fa-file-code code-icon',
        yml: 'fas fa-file-code code-icon',
        yaml: 'fas fa-file-code code-icon',
        php: 'fas fa-file-code code-icon',
        py: 'fas fa-file-code code-icon',
        java: 'fas fa-file-code code-icon',
        c: 'fas fa-file-code code-icon',
        cpp: 'fas fa-file-code code-icon',
        h: 'fas fa-file-code code-icon',
        hpp: 'fas fa-file-code code-icon',
        cs: 'fas fa-file-code code-icon',
        go: 'fas fa-file-code code-icon',
        rs: 'fas fa-file-code code-icon',
        sh: 'fas fa-file-code code-icon',
        bash: 'fas fa-file-code code-icon',
        zsh: 'fas fa-file-code code-icon',
        swift: 'fas fa-file-code code-icon',
        kt: 'fas fa-file-code code-icon',
        dart: 'fas fa-file-code code-icon',
        lua: 'fas fa-file-code code-icon',
        rb: 'fas fa-file-code code-icon',
        pl: 'fas fa-file-code code-icon',
        r: 'fas fa-file-code code-icon',
        m: 'fas fa-file-code code-icon',
        
        // 文本文件
        txt: 'fas fa-file-alt text-icon',
        md: 'fas fa-file-alt text-icon',
        markdown: 'fas fa-file-alt text-icon',
        log: 'fas fa-file-alt text-icon',
        rtf: 'fas fa-file-alt text-icon',
        
        // 文档
        pdf: 'fas fa-file-pdf text-red-500',
        doc: 'fas fa-file-word text-blue-600',
        docx: 'fas fa-file-word text-blue-600',
        xls: 'fas fa-file-excel text-green-600',
        xlsx: 'fas fa-file-excel text-green-600',
        ppt: 'fas fa-file-powerpoint text-orange-600',
        pptx: 'fas fa-file-powerpoint text-orange-600',
        csv: 'fas fa-file-csv text-green-600',
        odt: 'fas fa-file-word text-blue-600',
        ods: 'fas fa-file-excel text-green-600',
        odp: 'fas fa-file-powerpoint text-orange-600',
        
        // 数据库
        sql: 'fas fa-database text-blue-500',
        db: 'fas fa-database text-blue-500',
        sqlite: 'fas fa-database text-blue-500',
        mdb: 'fas fa-database text-blue-500',
        
        // 配置
        ini: 'fas fa-cog text-gray-500',
        cfg: 'fas fa-cog text-gray-500',
        conf: 'fas fa-cog text-gray-500',
        gitignore: 'fas fa-code-branch text-gray-500',
        env: 'fas fa-key text-yellow-500',
        
        // 字体
        ttf: 'fas fa-font text-purple-500',
        otf: 'fas fa-font text-purple-500',
        woff: 'fas fa-font text-purple-500',
        woff2: 'fas fa-font text-purple-500',
        
        // 视频
        mp4: 'fas fa-file-video text-red-400',
        mov: 'fas fa-file-video text-red-400',
        avi: 'fas fa-file-video text-red-400',
        mkv: 'fas fa-file-video text-red-400',
        flv: 'fas fa-file-video text-red-400',
        wmv: 'fas fa-file-video text-red-400',
        
        // 音频
        mp3: 'fas fa-file-audio text-blue-400',
        wav: 'fas fa-file-audio text-blue-400',
        ogg: 'fas fa-file-audio text-blue-400',
        flac: 'fas fa-file-audio text-blue-400',
        aac: 'fas fa-file-audio text-blue-400',
        
        // 其他
        lock: 'fas fa-lock text-gray-500',
        license: 'fas fa-file-signature text-gray-500',
        dockerfile: 'fab fa-docker text-blue-400',
        makefile: 'fas fa-file-code code-icon',
        procfile: 'fas fa-file-code code-icon',
    }
};

// ==================== 工具函数 ====================

// 辅助函数：将文件读取为Base64
function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const arrayBuffer = reader.result;
            const binaryString = Array.from(new Uint8Array(arrayBuffer))
                .map(b => String.fromCharCode(b))
                .join('');
            resolve(btoa(binaryString));
        };
        reader.onerror = () => reject(new Error('文件读取失败'));
        reader.readAsArrayBuffer(file);
    });
}

// 辅助函数：检查文件是否存在并返回SHA
async function getFileShaIfExists(filePath) {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${filePath}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Cache-Control': 'no-cache'
                }
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            return data.sha;
        } else if (response.status === 404) {
            return null;
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || '检查文件状态失败');
        }
    } catch (error) {
        console.error('获取SHA错误:', error);
        throw error;
    }
}

// 辅助函数：编码GitHub路径
function encodeGitHubPath(path) {
    return path.split('/').map(encodeURIComponent).join('/');
}

// 辅助函数：检查文件是否存在并返回SHA（简化版）
async function getFileShaIfExistsSimple(filePath) {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            return data.sha;
        }
        return null;
    } catch (error) {
        return null;
    }
}

// 辅助函数：将文件读取为Base64（简化版
function readFileAsBase64Simple(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            // 直接转换整个结果为base64
            const base64 = btoa(reader.result);
            resolve(base64);
        };
        reader.onerror = () => reject(new Error('文件读取失败'));
        reader.readAsBinaryString(file); 
    });
}

// ==================== 状态管理模块 ====================
const StateManager = {
    currentRepo: '',
    currentPath: '',
    currentFiles: [],
    githubToken: '',
    fileToDelete: null,
    selectedFiles: new Set(),
    contextMenuTarget: null,
    currentUser: null,
    buildTimer: null,
    buildStatus: null,
    pagesEnabledMap: new Map(),
    
    // 编辑器相关状态
    editor: null,
    currentEditingFile: null,
    monacoInitialized: false,
    monacoLoadAttempted: false,
    monacoLoadPromise: null,

    // 状态操作方法
    resetSelection() {
        this.selectedFiles.clear();
        this.updateSelectedCount();
    },

    updateSelectedCount() {
        const selectedCount = document.getElementById('selected-count');
        if (selectedCount) {
            selectedCount.textContent = this.selectedFiles.size;
        }
    },

    setCurrentRepo(repo) {
        this.currentRepo = repo;
    },

    setCurrentPath(path) {
        this.currentPath = path;
    },

    setCurrentFiles(files) {
        this.currentFiles = files;
    },

    setToken(token) {
        this.githubToken = token;
        localStorage.setItem('github_token', token);
    },

    clearToken() {
        this.githubToken = '';
        localStorage.removeItem('github_token');
    },

    addSelectedFile(file) {
    // 使用文件的路径作为唯一标识符
    const fileKey = file.path || `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${file.name}`;
    
    // 检查是否已存在
    let exists = false;
    for (let selectedFile of this.selectedFiles) {
        const selectedKey = selectedFile.path || `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${selectedFile.name}`;
        if (selectedKey === fileKey) {
            exists = true;
            break;
        }
    }
    
    if (!exists) {
        this.selectedFiles.add(file);
        this.updateSelectedCount();
    }
},

removeSelectedFile(file) {
    // 找到并删除对应的文件
    const fileKey = file.path || `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${file.name}`;
    
    for (let selectedFile of this.selectedFiles) {
        const selectedKey = selectedFile.path || `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${selectedFile.name}`;
        if (selectedKey === fileKey) {
            this.selectedFiles.delete(selectedFile);
            break;
        }
    }
    this.updateSelectedCount();
},

clearSelectedFiles() {
    this.selectedFiles.clear();
    this.updateSelectedCount();
},

updateSelectedCount() {
    const selectedCount = document.getElementById('selected-count');
    if (selectedCount) {
        selectedCount.textContent = this.selectedFiles.size;
    }
    
    // 更新批量工具栏显示
    const batchToolbar = document.getElementById('batch-toolbar');
    if (batchToolbar) {
        if (this.selectedFiles.size > 0) {
            batchToolbar.classList.add('visible');
        } else {
            batchToolbar.classList.remove('visible');
        }
    }
}};

// ==================== DOM 管理模块 ====================
const DOMManager = {
    // DOM 元素引用
    elements: {},

    // 初始化DOM元素引用
    init() {
        this.elements = {
            // 认证界面
            authScreen: document.getElementById('auth-screen'),
            authBtn: document.getElementById('auth-btn'),
            authBtnText: document.getElementById('auth-btn-text'),
            authSpinner: document.getElementById('auth-spinner'),
            githubTokenInput: document.getElementById('github-token'),
            tokenError: document.getElementById('token-error'),

            // 主界面
            mainScreen: document.getElementById('main-screen'),
            currentPath: document.getElementById('current-path'),
            fileList: document.getElementById('file-list'),
            loading: document.getElementById('loading'),
            emptyState: document.getElementById('empty-state'),

            // 工具栏按钮
            refreshBtn: document.getElementById('refresh-btn'),
            newRepoBtn: document.getElementById('new-repo-btn'),
            forkRepoBtn: document.getElementById('fork-repo-btn'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            selectBtn: document.getElementById('select-btn'),
            staticSiteBtn: document.getElementById('static-site-btn'),

            // 用户菜单
            userMenuBtn: document.getElementById('user-menu-btn'),
            userMenuContent: document.getElementById('user-menu-content'),
            username: document.getElementById('username'),
            logoutBtn: document.getElementById('logout-btn'),

            // 批量操作
            batchToolbar: document.getElementById('batch-toolbar'),
            selectedCount: document.getElementById('selected-count'),
            batchDownloadBtn: document.getElementById('batch-download-btn'),
            batchDeleteBtn: document.getElementById('batch-delete-btn'),
            batchCancelBtn: document.getElementById('batch-cancel-btn'),

            // 编辑器
            editorContainer: document.getElementById('editor-container'),
            editorSaveBtn: document.getElementById('editor-save-btn'),
            editorCloseBtn: document.getElementById('editor-close-btn'),
            editorFilename: document.getElementById('editor-filename'),
            editorFileSize: document.getElementById('editor-file-size'),
            editorLanguage: document.getElementById('editor-language'),

            // 移动设备工具栏
            mobileSaveBtn: document.getElementById('mobile-save-btn'),
            mobileCloseBtn: document.getElementById('mobile-close-btn'),
            mobileUndoBtn: document.getElementById('mobile-undo-btn'),
            mobileRedoBtn: document.getElementById('mobile-redo-btn'),
            mobileSearchBtn: document.getElementById('mobile-search-btn'),

            // 对话框
            confirmDialog: document.getElementById('confirm-dialog'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),

            // 新建文件夹对话框
            newFolderDialog: document.getElementById('new-folder-dialog'),
            newFolderName: document.getElementById('new-folder-name'),
            newFolderCreate: document.getElementById('new-folder-create'),
            newFolderCancel: document.getElementById('new-folder-cancel'),

            // 新建仓库对话框
            newRepoDialog: document.getElementById('new-repo-dialog'),
            newRepoName: document.getElementById('new-repo-name'),
            newRepoDesc: document.getElementById('new-repo-desc'),
            newRepoPrivate: document.getElementById('new-repo-private'),
            newRepoCreate: document.getElementById('new-repo-create'),
            newRepoCancel: document.getElementById('new-repo-cancel'),

            // 复刻仓库对话框
            forkRepoDialog: document.getElementById('fork-repo-dialog'),
            forkRepoUrl: document.getElementById('fork-repo-url'),
            forkRepoConfirm: document.getElementById('fork-repo-confirm'),
            forkRepoCancel: document.getElementById('fork-repo-cancel'),

            // 上传文件对话框
            uploadDialog: document.getElementById('upload-dialog'),
            fileInput: document.getElementById('file-input'),
            uploadFile: document.getElementById('upload-file'),
            uploadCancel: document.getElementById('upload-cancel'),

            // 部署网站对话框
            staticSiteDialog: document.getElementById('static-site-dialog'),
            pagesBranch: document.getElementById('pages-branch'),
            pagesFolder: document.getElementById('pages-folder'),
            pagesStatus: document.getElementById('pages-status'),
            pagesUrl: document.getElementById('pages-url'),
            staticSiteEnable: document.getElementById('static-site-enable'),
            staticSiteCancel: document.getElementById('static-site-cancel'),

           // 上下文菜单
contextMenu: document.getElementById('context-menu'),
contextOpen: document.getElementById('context-open'),
contextDownload: document.getElementById('context-download'),
contextRename: document.getElementById('context-rename'),
contextCopyLink: document.getElementById('context-copy-link'),
contextCopyProxyLink: document.getElementById('context-copy-proxy-link'),
contextDelete: document.getElementById('context-delete'),
contextEnablePages: document.getElementById('context-enable-pages'),
contextBuildApp: document.getElementById('context-build-app'),
contextDownloadSource: document.getElementById('context-download-source'),
contextCopyRepoLink: document.getElementById('context-copy-repo-link'),
contextCopySiteLink: document.getElementById('context-copy-site-link'),
contextRenameRepo: document.getElementById('context-rename-repo'),

            // 提示和状态
            toast: document.getElementById('toast'),
            buildStatus: document.getElementById('build-status'),
            buildIcon: document.getElementById('build-icon'),
            buildMessage: document.getElementById('build-message'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            closeBuildStatus: document.getElementById('close-build-status')
        };
    },

    // 显示/隐藏方法
    show(element) {
        if (element) element.classList.remove('hidden');
    },

    hide(element) {
        if (element) element.classList.add('hidden');
    },

    toggle(element) {
        if (element) element.classList.toggle('hidden');
    },

    // 特定元素的显示/隐藏
    showMainScreen() {
        this.hide(this.elements.authScreen);
        this.show(this.elements.mainScreen);
    },

    showAuthScreen() {
        this.hide(this.elements.mainScreen);
        this.show(this.elements.authScreen);
    },

    showLoading() {
        this.hide(this.elements.fileList);
        this.hide(this.elements.emptyState);
        this.show(this.elements.loading);
    },

    showFileList() {
        this.hide(this.elements.loading);
        this.hide(this.elements.emptyState);
        this.show(this.elements.fileList);
    },

    showEmptyState() {
        this.hide(this.elements.fileList);
        this.hide(this.elements.loading);
        this.show(this.elements.emptyState);
    },

    showBatchToolbar() {
        if (this.elements.batchToolbar) {
            this.elements.batchToolbar.classList.add('visible');
        }
    },

    hideBatchToolbar() {
        if (this.elements.batchToolbar) {
            this.elements.batchToolbar.classList.remove('visible');
        }
    },

     // 更新按钮状态
    updateButtonVisibility(isRepoView) {
        const {
            uploadBtn, newFolderBtn, selectBtn, 
            staticSiteBtn, newRepoBtn, forkRepoBtn
        } = this.elements;

        if (isRepoView) {
            this.hide(uploadBtn);
            this.hide(newFolderBtn);
            this.hide(selectBtn);
            this.hide(staticSiteBtn);
            this.show(newRepoBtn);
            this.show(forkRepoBtn);
        } else {
            this.show(uploadBtn);
            this.show(newFolderBtn);
            this.show(selectBtn);
            this.hide(newRepoBtn);
            this.hide(forkRepoBtn);
        }
    }
};

// ==================== API 服务模块 ====================
const APIService = {
    baseURL: 'https://api.github.com',
    graphqlURL: 'https://api.github.com/graphql',

    // 通用请求方法
async request(url, options = {}) {
    const token = StateManager.githubToken;
    if (!token) throw new Error('未找到认证令牌');

    const defaultOptions = {
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            ...options.headers
        }
    };

    const response = await fetch(url, { ...defaultOptions, ...options });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `请求失败: ${response.status}`);
    }

    return response;
},

   // GraphQL 请求
    async graphql(query) {
        const token = StateManager.githubToken;
        if (!token) throw new Error('未找到认证令牌');

        const response = await fetch(this.graphqlURL, {
            method: 'POST',
            headers: {
                'Authorization': `bearer ${token}`, 
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify({ query })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `GraphQL请求失败: ${response.status}`);
        }

        return response.json();
    },
    
    // 通用请求头生成方法
getAuthHeaders() {
    return {
        'Authorization': `token ${StateManager.githubToken}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    };
},

// 然后修改 enableGitHubPages 方法
async enableGitHubPages(owner, repo, branch, path) {
    const response = await fetch(
        `${this.baseURL}/repos/${owner}/${repo}/pages`,
        {
            method: 'POST',
            headers: this.getAuthHeaders(),
            body: JSON.stringify({
                source: {
                    branch: branch,
                    path: path
                }
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `启用 Pages 失败: ${response.status}`);
    }

    return response.json();
},

    // 用户认证
    async verifyToken(token) {
        const response = await fetch(`${this.baseURL}/user`, {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '认证失败');
        }
        
        return response.json();
    },

    // 获取仓库列表 - 修复版本
async getRepositories() {
    const query = `
        query {
            viewer {
                repositories(first: 100, ownerAffiliations: [OWNER], orderBy: {field: NAME, direction: ASC}) {
                    nodes {
                        name
                        owner {
                            login
                        }
                        isPrivate
                        description
                        updatedAt
                    }
                }
            }
        }
    `;
    
    const data = await this.graphql(query);
    
    // 并行检查每个仓库的Pages状态
    const reposWithPagesStatus = await Promise.all(
        data.data.viewer.repositories.nodes.map(async repo => {
            try {
                const pagesStatus = await this.getPagesStatus(repo.owner.login, repo.name);
                const pagesEnabled = pagesStatus && (pagesStatus.status === 'built' || pagesStatus.status === 'building');
                
                return {
                    name: repo.name,
                    type: 'repo',
                    path: `${repo.owner.login}/${repo.name}`,
                    private: repo.isPrivate,
                    description: repo.description,
                    updatedAt: repo.updatedAt,
                    pagesEnabled: pagesEnabled  // 新增字段
                };
            } catch (error) {
                console.error(`检查仓库 ${repo.name} Pages状态失败:`, error);
                return {
                    name: repo.name,
                    type: 'repo',
                    path: `${repo.owner.login}/${repo.name}`,
                    private: repo.isPrivate,
                    description: repo.description,
                    updatedAt: repo.updatedAt,
                    pagesEnabled: false
                };
            }
        })
    );

    return reposWithPagesStatus;
},

    // 获取仓库内容
    async getRepositoryContents(repo, path = '') {
        const [owner, repoName] = repo.split('/');
        const query = `
            query {
                repository(owner: "${owner}", name: "${repoName}") {
                    object(expression: "HEAD:${path}") {
                        ... on Tree {
                            entries {
                                name
                                type
                                object {
                                    ... on Blob {
                                        byteSize
                                    }
                                }
                            }
                        }
                    }
                }
            }
        `;

        const data = await this.graphql(query);
        
        if (!data.data.repository.object) {
            return [];
        }

        return data.data.repository.object.entries.map(entry => ({
            name: entry.name,
            type: entry.type === 'tree' ? 'dir' : 'file',
            size: entry.object?.byteSize || 0,
            path: path ? `${path}/${entry.name}` : entry.name,
            download_url: entry.type === 'blob' ? 
                `https://raw.githubusercontent.com/${repo}/HEAD/${path ? path + '/' : ''}${entry.name}` : null
        }));
    },

    // 获取文件内容 - 修复版本
async getFileContent(repo, path) {
    try {
        const response = await fetch(
            `${this.baseURL}/repos/${repo}/contents/${encodeURIComponent(path)}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '获取文件内容失败');
        }
        
        const data = await response.json();
        
        // 解码base64内容
        const decodedContent = this.decodeBase64Content(data.content);
        
        return {
            content: decodedContent,
            sha: data.sha
        };
    } catch (error) {
        console.error('获取文件内容错误:', error);
        throw error;
    }
},


    // 创建文件
    async createFile(repo, path, content, message) {
        const base64Content = btoa(unescape(encodeURIComponent(content)));
        
        const response = await this.request(`${this.baseURL}/repos/${repo}/contents/${path}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message,
                content: base64Content
            })
        });

        return response.json();
    },

    // 更新文件 - 修复版本
async updateFile(repo, path, content, sha, message) {
    const base64Content = btoa(unescape(encodeURIComponent(content)));
    
    const response = await fetch(
        `${this.baseURL}/repos/${repo}/contents/${encodeURIComponent(path)}`,
        {
            method: 'PUT',
            headers: {
                'Authorization': `token ${StateManager.githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message,
                content: base64Content,
                sha
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `更新失败: ${response.status}`);
    }

    return response.json();
},

// 改进的Base64解码方法
decodeBase64Content(base64) {
    try {
        const binaryString = atob(base64);
        
        // 尝试UTF-8解码
        try {
            return decodeURIComponent(escape(binaryString));
        } catch (e) {
            // 如果UTF-8解码失败，返回原始内容
            return binaryString;
        }
    } catch (error) {
        console.error('Base64解码失败:', error);
        // 尝试直接返回
        try {
            return atob(base64);
        } catch (e2) {
            throw new Error('文件内容解码失败');
        }
    }
},

   // 删除文件 
    async deleteFile(repo, path, sha, message) {
        const response = await this.request(`${this.baseURL}/repos/${repo}/contents/${encodeURIComponent(path)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message,
                sha
            })
        });

        return response.json();
    },

    // 创建仓库 - 修复版本
async createRepository(name, description, isPrivate) {
    const response = await this.request(`${this.baseURL}/user/repos`, {
        method: 'POST',
        body: JSON.stringify({
            name,
            description: description || '',
            private: !!isPrivate,
            auto_init: true
        })
    });

    return response.json();
},

    // 删除仓库
    async deleteRepository(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}`, {
            method: 'DELETE'
        });

        return response.status === 204;
    },

    // 复刻仓库
    async forkRepository(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}/forks`, {
            method: 'POST'
        });

        return response.json();
    },

    // 获取仓库信息
    async getRepositoryInfo(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}`);
        return response.json();
    },

    // 启用 GitHub Pages - 修复版本
async enableGitHubPages(owner, repo, branch, path) {
    // 直接使用 fetch 确保认证头正确传递
    const response = await fetch(
        `${this.baseURL}/repos/${owner}/${repo}/pages`,
        {
            method: 'POST',
            headers: {
                'Authorization': `token ${StateManager.githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                source: {
                    branch: branch,
                    path: path
                }
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `启用 Pages 失败: ${response.status}`);
    }

    return response.json();
},

    // 禁用 GitHub Pages
    async disableGitHubPages(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}/pages`, {
            method: 'DELETE'
        });

        return response.status === 204;
    },

    // 获取 Pages 状态
    async getPagesStatus(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}/pages`);
        return response.json();
    },

    // 触发工作流
    async triggerWorkflow(owner, repo, workflowFileName, branch) {
        const response = await this.request(
            `${this.baseURL}/repos/${owner}/${repo}/actions/workflows/${workflowFileName}/dispatches`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ref: branch
                })
            }
        );

        return response.status === 204;
    },

    // 获取工作流运行状态
    async getWorkflowRuns(owner, repo) {
        const response = await this.request(`${this.baseURL}/repos/${owner}/${repo}/actions/runs`);
        return response.json();
    },

    // 工具函数
    decodeBase64Utf8(base64) {
        try {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new TextDecoder('utf-8').decode(bytes);
        } catch (e) {
            try {
                return decodeURIComponent(escape(atob(base64)));
            } catch (e2) {
                console.error('Base64解码失败:', e2);
                return atob(base64);
            }
        }
    }
};

// ==================== 文件管理模块 ====================
const FileManager = {
    // 渲染文件列表
    renderFileList(items) {
        const fileListElement = DOMManager.elements.fileList;
        if (!fileListElement) return;

        fileListElement.innerHTML = '';
        DOMManager.showFileList();

        if (items.length === 0) {
            DOMManager.showEmptyState();
            return;
        }

        items.forEach(item => {
            const fileItem = this.createFileItem(item);
            fileListElement.appendChild(fileItem);
        });
    },

    // 创建文件项
createFileItem(item) {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item p-4 flex items-center';
    fileItem.dataset.name = item.name;
    fileItem.dataset.type = item.type;
    fileItem.dataset.path = item.path || ''; // 添加路径信息

    // 添加右键菜单
    fileItem.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        ContextMenuManager.show(e, item);
    });

    // 点击事件
    fileItem.addEventListener('click', (e) => {
        this.handleFileClick(e, item);
    });

    // 创建文件内容
    const icon = this.createFileIcon(item);
    const infoContainer = this.createFileInfo(item);

    fileItem.appendChild(icon);
    fileItem.appendChild(infoContainer);

    return fileItem;
},

    // 创建文件图标
    createFileIcon(item) {
        const icon = document.createElement('i');
        
        if (item.type === 'dir') {
            icon.className = 'file-icon fas fa-folder folder-icon';
        } else if (item.type === 'repo') {
            icon.className = 'file-icon fab fa-github text-gray-700';
        } else {
            const extension = item.name.split('.').pop().toLowerCase();
            const iconClass = Config.fileTypeIcons[extension] || 'fas fa-file text-gray-400';
            icon.className = `file-icon ${iconClass}`;
        }

        return icon;
    },

    // 创建文件信息
createFileInfo(item) {
    const infoContainer = document.createElement('div');
    infoContainer.className = 'flex-1 min-w-0';

    const nameContainer = document.createElement('div');
    nameContainer.className = 'flex items-center gap-2 mb-1';

    const name = document.createElement('div');
    name.className = 'font-medium truncate';
    name.textContent = item.name;

    nameContainer.appendChild(name);

    // 新增：如果是仓库且已部署网站，显示标签
    if (item.type === 'repo' && item.pagesEnabled) {
        const siteBadge = document.createElement('span');
        siteBadge.className = 'bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium';
        siteBadge.textContent = '网站已部署';
        nameContainer.appendChild(siteBadge);
    }

    const meta = document.createElement('div');
    meta.className = 'text-xs text-gray-500 truncate';

    if (item.type === 'repo') {
        meta.textContent = item.private ? '私有仓库' : '公开仓库';
        if (item.description) {
            meta.textContent += ' • ' + item.description;
        }
        if (item.updatedAt) {
            meta.textContent += ' • 更新: ' + this.formatDate(item.updatedAt);
        }
    } else if (item.type === 'file') {
        meta.textContent = this.formatFileSize(item.size);
        
        // 添加操作链接（桌面端显示）
        if (window.innerWidth > 768) {
            const openLink = this.createActionLink('编辑', () => EditorManager.openFileInEditor(item));
            const downloadLink = this.createActionLink('下载', () => this.downloadFile(item));
            
            meta.appendChild(openLink);
            meta.appendChild(downloadLink);
        }
    } else {
        meta.textContent = '文件夹 • 点击进入';
    }

    infoContainer.appendChild(nameContainer);
    infoContainer.appendChild(meta);

    return infoContainer;
},

    // 创建操作链接
    createActionLink(text, onClick) {
        const link = document.createElement('a');
        link.href = '#';
        link.className = 'text-blue-500 hover:underline ml-2 text-xs';
        link.textContent = text;
        link.addEventListener('click', (e) => {
            e.stopPropagation();
            onClick();
        });
        return link;
    },

   // 处理文件点击
    handleFileClick(e, item) {
    e.preventDefault();
    e.stopPropagation();

    // 首先检查是否在选择模式
    if (SelectionManager.isInSelectMode()) {
        // 在选择模式下，处理文件选择
        SelectionManager.handleFileSelection(e.currentTarget, item);
        return;
    }

    // 正常点击行为
    if (item.type === 'dir') {
        NavigationManager.loadRepositoryContents(
            StateManager.currentRepo, 
            `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${item.name}`
        );
    } else if (item.type === 'repo') {
        NavigationManager.loadRepositoryContents(item.path);
    } else if (item.type === 'file') {
        this.handleFileOpen(item);
    }
},


    // 处理文件打开
    handleFileOpen(item) {
        const fileExt = item.name.split('.').pop().toLowerCase();
        
        // 文本文件 - 在编辑器中打开
        if (Config.textFileExtensions.includes(fileExt)) {
            EditorManager.openFileInEditor(item);
        } 
        // 图片文件 - 直接预览
        else if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp', 'bmp'].includes(fileExt)) {
            this.showImagePreview(item);
        }
        // PDF文件 - 在新窗口打开
        else if (fileExt === 'pdf') {
            window.open(item.download_url, '_blank');
        }
        // 其他文件 - 直接下载
        else {
            this.downloadFile(item);
        }
    },

    // 切换文件选择
    toggleFileSelection(fileItem, fileInfo) {
        if (fileItem.classList.contains('selected')) {
            fileItem.classList.remove('selected');
            StateManager.removeSelectedFile(fileInfo);
        } else {
            fileItem.classList.add('selected');
            StateManager.addSelectedFile(fileInfo);
        }

        // 如果没有选中文件，退出选择模式
        if (StateManager.selectedFiles.size === 0) {
            SelectionManager.exitSelectMode();
        }
    },

    // 下载文件
    async downloadFile(file) {
        if (file.type !== 'file' || !file.download_url) return;
        
        try {
            ToastManager.show(`正在下载 ${file.name}...`);
            
            const response = await fetch(file.download_url);
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = file.name;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }, 100);
            
            ToastManager.show(`已下载 ${file.name}`);
        } catch (error) {
            console.error('下载失败:', error);
            ToastManager.show(`下载失败: ${error.message}`);
        }
    },

    // 显示图片预览
    showImagePreview(item) {
        // 创建预览容器
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        previewContainer.innerHTML = `
            <div class="image-preview-content">
                <div class="image-preview-header">
                    <div class="image-preview-title">${item.name}</div>
                    <button class="image-preview-close" title="关闭">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="image-preview-body">
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <div class="image-preview-footer">
                    <div class="background-toggle">
                        <button class="btn-bg-light" title="浅色背景">
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="btn-bg-dark" title="深色网格背景">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="btn-bg-grid" title="浅色网格背景">
                            <i class="fas fa-border-all"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // 添加到页面
        document.body.appendChild(previewContainer);
        document.body.style.overflow = 'hidden';
        
        // 获取图片容器元素
        const imgBody = previewContainer.querySelector('.image-preview-body');
        
        // 使用API获取图片内容
        this.fetchImageContent(item).then(blobUrl => {
            // 移除加载指示器
            imgBody.innerHTML = '';
            
            // 创建图片元素
            const img = document.createElement('img');
            img.src = blobUrl;
            img.alt = item.name;
            img.loading = 'lazy';
            imgBody.appendChild(img);
            
            // 根据图片类型设置初始背景
            const ext = item.name.split('.').pop().toLowerCase();
            const isTransparent = ['png', 'gif', 'svg', 'webp'].includes(ext);
            
            if (isTransparent) {
                imgBody.classList.add('checkerboard-dark-bg');
            }
            
            // 背景切换功能
            previewContainer.querySelector('.btn-bg-light').addEventListener('click', () => {
                imgBody.className = 'image-preview-body light-bg';
            });
            
            previewContainer.querySelector('.btn-bg-dark').addEventListener('click', () => {
                imgBody.className = 'image-preview-body checkerboard-dark-bg';
            });
            
            previewContainer.querySelector('.btn-bg-grid').addEventListener('click', () => {
                imgBody.className = 'image-preview-body checkerboard-bg';
            });
            
            // 图片加载错误处理
            img.onerror = () => {
                imgBody.innerHTML = '<div class="text-red-500">图片加载失败</div>';
                URL.revokeObjectURL(blobUrl);
            };
            
            // 图片加载成功后释放内存
            img.onload = () => {
                setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
            };
        }).catch(error => {
            console.error('获取图片失败:', error);
            imgBody.innerHTML = '<div class="text-red-500">图片加载失败: ' + error.message + '</div>';
        });
        
        // 关闭预览的函数
        const closePreview = () => {
            document.body.removeChild(previewContainer);
            document.body.style.overflow = '';
        };
        
        // 添加关闭事件
        previewContainer.querySelector('.image-preview-close').addEventListener('click', closePreview);
        
        // ESC键关闭
        document.addEventListener('keydown', function escClose(e) {
            if (e.key === 'Escape') {
                closePreview();
                document.removeEventListener('keydown', escClose);
            }
        });
    },

    // 获取图片内容
    async fetchImageContent(fileInfo) {
        const apiUrl = `https://api.github.com/repos/${StateManager.currentRepo}/contents/${
            StateManager.currentPath ? encodeURIComponent(StateManager.currentPath) + '/' : ''
        }${encodeURIComponent(fileInfo.name)}`;
        
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${StateManager.githubToken}`,
                'Accept': 'application/vnd.github.v3.raw'
            }
        });
        
        if (!response.ok) {
            throw new Error('获取图片内容失败: ' + response.status);
        }
        
        const blob = await response.blob();
        
        // 检查文件扩展名，如果是svg，则修正MIME类型
        const ext = fileInfo.name.split('.').pop().toLowerCase();
        if (ext === 'svg') {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const svgString = reader.result;
                    const correctedBlob = new Blob([svgString], { type: 'image/svg+xml' });
                    resolve(URL.createObjectURL(correctedBlob));
                };
                reader.readAsText(blob);
            });
        }
        
        return URL.createObjectURL(blob);
    },

    // 工具函数
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
};

// ==================== 导航管理模块 ====================
const NavigationManager = {
    // 加载仓库列表 - 修复版本
    async loadRepositories() {
        DOMManager.showLoading();
        StateManager.setCurrentPath('');
        StateManager.setCurrentRepo('');
        this.updateBreadcrumb([]);
        DOMManager.updateButtonVisibility(true);

        // 添加到浏览器历史记录 - 修复：确保正确添加状态
        this.pushHistoryState('repositories', { type: 'repositories' });

        try {
            const repos = await APIService.getRepositories();
            FileManager.renderFileList(repos);
        } catch (error) {
            console.error('加载仓库列表错误:', error);
            ToastManager.show('加载失败: ' + error.message);
            DOMManager.showEmptyState();
        }
    },

    // 加载仓库内容 - 修复版本
    async loadRepositoryContents(repo, path = '') {
        DOMManager.showLoading();
        StateManager.setCurrentRepo(repo);
        StateManager.setCurrentPath(path);
        
        DOMManager.updateButtonVisibility(false);
        
        // 更新面包屑导航
        const pathParts = path ? path.split('/') : [];
        this.updateBreadcrumb([repo, ...pathParts]);
        
        // 添加到浏览器历史记录 - 修复：确保每次都添加
        this.pushHistoryState('contents', { repo, path });

        try {
            const contents = await APIService.getRepositoryContents(repo, path);
            StateManager.setCurrentFiles(contents);
            
            const sortedContents = [...contents].sort((a, b) => {
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name);
                }
                return a.type === 'dir' ? -1 : 1;
            });
            
            FileManager.renderFileList(sortedContents);
            
            // 智能显示部署网站按钮
            this.updateStaticSiteButton(contents, path);
            
        } catch (error) {
            console.error('加载仓库内容错误:', error);
            ToastManager.show('加载失败: ' + error.message);
            DOMManager.showEmptyState();
        }
    },

    // 添加到浏览器历史记录 - 修复版本
    pushHistoryState(type, data) {
        const state = {
            type: type,
            data: data,
            timestamp: Date.now()
        };
        
        const title = type === 'repositories' ? '我的仓库' : `${data.repo} - ${data.path || '根目录'}`;
        const url = this.createURL(type, data);
        
        // 修复：检查是否与当前状态相同，避免重复添加
        const currentState = history.state;
        if (currentState && 
            currentState.type === type && 
            JSON.stringify(currentState.data) === JSON.stringify(data)) {
            return; // 状态相同，不重复添加
        }
        
        // 修复：使用正确的历史记录管理
        if (!currentState) {
            // 首次加载，使用 replaceState
            history.replaceState(state, title, url);
        } else {
            // 后续导航，使用 pushState
            history.pushState(state, title, url);
        }
    },

    // 创建URL - 修复版本
    createURL(type, data) {
        if (type === 'repositories') {
            return window.location.pathname; 
        } else if (type === 'contents') {
            const repo = encodeURIComponent(data.repo);
            const path = data.path ? encodeURIComponent(data.path) : '';
            return path ? `?repo=${repo}&path=${path}` : `?repo=${repo}`;
        }
        return window.location.pathname;
    },

    // 处理浏览器前进/后退 - 修复版本
    handlePopState(event) {
        // 优先使用event.state，如果没有则解析URL
        if (event.state && event.state.type) {
            const { type, data } = event.state;
            this.navigateToState(type, data);
        } else {
            const state = this.parseURL();
            this.navigateToState(state.type, state.data);
        }
    },
    
    // 解析URL参数
    parseURL() {
        // 如果URL中没有参数，默认显示仓库列表
        if (!window.location.search) {
            return { type: 'repositories', data: {} };
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const repo = urlParams.get('repo');
        const path = urlParams.get('path');
        
        if (repo) {
            return { type: 'contents', data: { repo: decodeURIComponent(repo), path: path ? decodeURIComponent(path) : '' } };
        }
        return { type: 'repositories', data: {} };
    },

    // 导航到指定状态
    navigateToState(type, data) {
        if (type === 'repositories') {
            this.loadRepositories();
        } else if (type === 'contents') {
            this.loadRepositoryContents(data.repo, data.path);
        } else {
            // 默认情况
            this.loadRepositories();
        }
    },

    // 更新面包屑导航
    updateBreadcrumb(parts) {
        const breadcrumbContainer = DOMManager.elements.currentPath?.querySelector('.breadcrumb');
        if (!breadcrumbContainer) return;

        breadcrumbContainer.innerHTML = '';
        
        // 添加"我的仓库"根路径
        const rootItem = document.createElement('div');
        rootItem.className = 'breadcrumb-item';
        rootItem.innerHTML = '<i class="fab fa-github mr-1"></i><span>我的仓库</span>';
        rootItem.onclick = () => this.loadRepositories();
        breadcrumbContainer.appendChild(rootItem);
            
        if (parts.length === 0) return;
        
        // 添加分隔符
        this.addBreadcrumbSeparator(breadcrumbContainer);
        
        // 添加仓库部分
        const repoItem = document.createElement('div');
        const repoName = parts[0].split('/').pop();
        repoItem.textContent = repoName;
        repoItem.onclick = () => this.loadRepositoryContents(parts[0]);
        breadcrumbContainer.appendChild(repoItem);
        
        // 添加路径部分
        for (let i = 1; i < parts.length; i++) {
            this.addBreadcrumbSeparator(breadcrumbContainer);
            
            const pathItem = document.createElement('div');
            pathItem.className = 'breadcrumb-item';
            pathItem.textContent = parts[i];
            pathItem.onclick = () => {
                this.loadRepositoryContents(parts[0], parts.slice(1, i + 1).join('/'));
            };
            breadcrumbContainer.appendChild(pathItem);
        }
    },

    // 添加面包屑分隔符
    addBreadcrumbSeparator(container) {
        const separator = document.createElement('div');
        separator.className = 'breadcrumb-separator';
        separator.innerHTML = '<i class="fas fa-chevron-right"></i>';
        container.appendChild(separator);
    },

    // 更新部署网站按钮显示
    updateStaticSiteButton(contents, path) {
        const hasWebContent = contents.some(file => 
            file.type === 'file' && 
            (file.name.toLowerCase() === 'index.html' || 
             file.name.toLowerCase() === 'index.md')
        );
        
        const isRoot = path === '';
        
        if (hasWebContent && isRoot) {
            DOMManager.show(DOMManager.elements.staticSiteBtn);
        } else {
            DOMManager.hide(DOMManager.elements.staticSiteBtn);
        }
    },

    // 返回上一级
    goBack() {
        if (!StateManager.currentPath) {
            this.loadRepositories();
            return;
        }
        
        const pathParts = StateManager.currentPath.split('/');
        pathParts.pop();
        const newPath = pathParts.join('/');
        
        if (pathParts.length === 0) {
            this.loadRepositoryContents(StateManager.currentRepo);
        } else {
            this.loadRepositoryContents(StateManager.currentRepo, newPath);
        }
    }
};

// ==================== 编辑器管理模块 ====================
const EditorManager = {
    // 初始化编辑器
    async init() {
        if (StateManager.monacoInitialized) return Promise.resolve();
        if (StateManager.monacoLoadPromise) return StateManager.monacoLoadPromise;
        
        StateManager.monacoLoadAttempted = true;
        
        StateManager.monacoLoadPromise = new Promise((resolve, reject) => {
            if (window.monaco && window.monaco.editor) {
                StateManager.monacoInitialized = true;
                return resolve();
            }
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.min.js';
            script.crossOrigin = "anonymous";
            script.onload = () => {
                window.require.config({
                    paths: { 
                        'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs'
                    },
                    'vs/nls': {
                        availableLanguages: { '*': 'zh-cn' }
                    }
                });
                
                window.require(['vs/editor/editor.main'], () => {
                    try {
                        const editorOptions = {
                            value: '',
                            language: 'text',
                            theme: 'vs',
                            automaticLayout: true,
                            fontSize: 14,
                            minimap: { enabled: true },
                            scrollBeyondLastLine: false,
                            wordWrap: 'on',
                            wrappingIndent: 'indent'
                        };

                        if (window.innerWidth <= 768) {
                            editorOptions.minimap = { enabled: false };
                            editorOptions.fontSize = 10;
                            editorOptions.lineHeight = 16;
                        }

                        StateManager.editor = monaco.editor.create(document.getElementById('editor'), editorOptions);
                        StateManager.monacoInitialized = true;
                        
                        StateManager.editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                            this.saveFileChanges();
                        });

                        if (window.innerWidth <= 768) {
                            window.addEventListener('resize', this.handleMobileKeyboard);
                        }
                        
                        resolve();
                    } catch (createError) {
                        console.error('创建Monaco编辑器实例失败:', createError);
                        this.createFallbackEditor();
                        resolve();
                    }
                });
                
                window.require.onError = (err) => {
                    console.error('加载Monaco编辑器失败:', err);
                    this.createFallbackEditor();
                    resolve();
                };
            };
            
            script.onerror = (err) => {
                console.error('加载Monaco脚本失败:', err);
                this.createFallbackEditor();
                resolve();
            };
            
            document.head.appendChild(script);
        });
        
        return StateManager.monacoLoadPromise;
    },

    // 创建备用编辑器
    createFallbackEditor() {
        document.getElementById('editor').innerHTML = `
            <textarea id="fallback-editor" style="width:100%;height:100%;font-family:monospace;padding:10px;"></textarea>
        `;
    },

    // 在编辑器中打开文件 - 修复版本
async openFileInEditor(fileInfo) {
    if (fileInfo.size > 1024 * 1024) {
        ToastManager.show('文件过大，请在浏览器中查看');
        return;
    }
    
    const fileExt = fileInfo.name.split('.').pop().toLowerCase();
    if (!Config.textFileExtensions.includes(fileExt)) {
        ToastManager.show('不支持编辑此文件类型');
        return;
    }
    
    try {
        ToastManager.show('正在加载文件内容...');
        
        // 创建新的编辑文件对象
        StateManager.currentEditingFile = {
            ...fileInfo,
            path: StateManager.currentPath ? `${StateManager.currentPath}/${fileInfo.name}` : fileInfo.name
        };
        
        // 获取文件内容和SHA
        const fileContent = await this.getFileContentForEditor(StateManager.currentEditingFile.path);
        
        StateManager.currentEditingFile.sha = fileContent.sha;
        StateManager.currentEditingFile.content = fileContent.content;
        
        // 初始化编辑器并设置内容
        await this.init();
        this.setEditorContent(fileContent.content, fileExt);
        
    } catch (error) {
        console.error('打开编辑器失败:', error);
        ToastManager.show('加载文件失败: ' + error.message);
        StateManager.currentEditingFile = null;
    }
},

// 获取文件内容用于编辑器
async getFileContentForEditor(filePath) {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '获取文件内容失败');
        }
        
        const data = await response.json();
        
        // 解码base64内容
        let decodedContent;
        try {
            decodedContent = this.decodeBase64Content(data.content);
        } catch (decodeError) {
            console.error('Base64解码失败:', decodeError);
            // 尝试备用解码方法
            decodedContent = atob(data.content);
        }
        
        return {
            content: decodedContent,
            sha: data.sha
        };
    } catch (error) {
        console.error('获取文件内容错误:', error);
        throw error;
    }
},

// 解码Base64内容
decodeBase64Content(base64) {
    try {
        // 方法1: 直接atob
        const binaryString = atob(base64);
        
        // 方法2: 处理UTF-8字符
        try {
            return decodeURIComponent(escape(binaryString));
        } catch (e) {
            // 如果UTF-8解码失败，返回原始二进制字符串
            return binaryString;
        }
    } catch (error) {
        console.error('Base64解码错误:', error);
        throw new Error('文件内容解码失败');
    }
},
    // 设置编辑器内容
    setEditorContent(content, fileExt) {
        if (StateManager.editor && StateManager.editor.setValue) {
            StateManager.editor.setValue(content);
            
            const language = Config.languageMapping[fileExt] || 'text';
            monaco.editor.setModelLanguage(StateManager.editor.getModel(), language);
        } else if (document.getElementById('fallback-editor')) {
            document.getElementById('fallback-editor').value = content;
        }
        
        const { editorFilename, editorFileSize, editorLanguage } = DOMManager.elements;
        editorFilename.textContent = StateManager.currentEditingFile.name;
        editorFileSize.textContent = FileManager.formatFileSize(StateManager.currentEditingFile.size);
        editorLanguage.textContent = (Config.languageMapping[fileExt] || 'text').toUpperCase();
        
        DOMManager.show(DOMManager.elements.editorContainer);
        
        setTimeout(() => {
            if (StateManager.editor && StateManager.editor.focus) {
                StateManager.editor.focus();
            } else if (document.getElementById('fallback-editor')) {
                document.getElementById('fallback-editor').focus();
            }
        }, 100);
    },

   // 保存文件更改 - 修复版本
async saveFileChanges() {
    if (!StateManager.currentEditingFile) {
        ToastManager.show('没有可保存的文件');
        return;
    }
    
    try {
        let newContent;
        if (StateManager.editor && StateManager.editor.getValue) {
            newContent = StateManager.editor.getValue();
        } else if (document.getElementById('fallback-editor')) {
            newContent = document.getElementById('fallback-editor').value;
        } else {
            throw new Error('编辑器未初始化');
        }
        
        ToastManager.show('正在保存文件...');
        
        // 获取文件当前SHA
        const fileInfo = await this.getFileInfoForSave(StateManager.currentEditingFile.path);
        
        if (!fileInfo.sha) {
            throw new Error('无法获取文件SHA，保存失败');
        }
        
        // 执行保存
        await this.saveFileContent(
            StateManager.currentEditingFile.path,
            newContent,
            fileInfo.sha,
            `更新 ${StateManager.currentEditingFile.name}`
        );
        
        ToastManager.show('文件保存成功');
        this.closeEditor();
        NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        
    } catch (error) {
        console.error('保存文件失败:', error);
        ToastManager.show('保存失败: ' + error.message);
    }
},

// 获取文件信息用于保存
async getFileInfoForSave(filePath) {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            return { sha: data.sha, exists: true };
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || '获取文件信息失败');
        }
    } catch (error) {
        console.error('获取文件信息错误:', error);
        throw error;
    }
},

// 保存文件内容
async saveFileContent(filePath, content, sha, message) {
    // 将内容编码为Base64
    const base64Content = btoa(unescape(encodeURIComponent(content)));
    
    const response = await fetch(
        `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
        {
            method: 'PUT',
            headers: {
                'Authorization': `token ${StateManager.githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                content: base64Content,
                sha: sha
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `保存失败: ${response.status}`);
    }

    return response.json();
},

    // 关闭编辑器
    closeEditor() {
        DOMManager.hide(DOMManager.elements.editorContainer);
        StateManager.currentEditingFile = null;
    },

    // 移动端键盘处理
    handleMobileKeyboard() {
        if (!StateManager.editor) return;
        
        const editorContainer = DOMManager.elements.editorContainer;
        const editorElement = document.getElementById('editor');
        
        if (window.innerHeight < window.outerHeight * 0.9) {
            editorContainer.style.position = 'absolute';
            editorContainer.style.top = '0';
            editorContainer.style.height = (window.innerHeight - 100) + 'px';
            editorElement.style.height = (window.innerHeight - 150) + 'px';
        } else {
            editorContainer.style.position = 'fixed';
            editorContainer.style.height = '100%';
            editorElement.style.height = '';
        }
        
        if (StateManager.editor.layout) {
            StateManager.editor.layout();
        }
    }
};

// ==================== 选择管理模块 ====================
const SelectionManager = {
    // 进入选择模式
    enterSelectMode() {
        const selectBtn = DOMManager.elements.selectBtn;
        if (selectBtn) {
            selectBtn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
            selectBtn.title = '取消选择';
        }
        
        // 添加选择模式样式提示
        document.querySelectorAll('.file-item').forEach(item => {
            item.style.cursor = 'pointer';
        });
        
        DOMManager.showBatchToolbar();
        StateManager.clearSelectedFiles();
    },

    // 退出选择模式
    exitSelectMode() {
        StateManager.clearSelectedFiles();
        DOMManager.hideBatchToolbar();
        
        // 移除所有选中状态
        document.querySelectorAll('.file-item.selected').forEach(item => {
            item.classList.remove('selected');
        });
        
        const selectBtn = DOMManager.elements.selectBtn;
        if (selectBtn) {
            selectBtn.innerHTML = '<i class="fas fa-check-square text-blue-500"></i>';
            selectBtn.title = '选择文件';
        }
        
        // 恢复默认样式
        document.querySelectorAll('.file-item').forEach(item => {
            item.style.cursor = '';
        });
    },

    // 切换选择模式 - 修复版本
    toggleSelectMode() {
        if (StateManager.selectedFiles.size > 0 || this.isInSelectMode()) {
            this.exitSelectMode();
        } else {
            this.enterSelectMode();
        }
    },

    // 检查是否在选择模式
    isInSelectMode() {
        const selectBtn = DOMManager.elements.selectBtn;
        return selectBtn && selectBtn.innerHTML.includes('fa-times');
    },

    // 处理文件选择
handleFileSelection(fileItem, fileInfo) {
    if (!this.isInSelectMode()) {
        return false; // 不在选择模式，不处理选择
    }

    if (fileItem.classList.contains('selected')) {
        fileItem.classList.remove('selected');
        StateManager.removeSelectedFile(fileInfo);
    } else {
        fileItem.classList.add('selected');
        StateManager.addSelectedFile(fileInfo);
    }

    // 更新选中数量显示
    this.updateSelectionCount();

    // 如果没有选中文件，退出选择模式
    if (StateManager.selectedFiles.size === 0) {
        this.exitSelectMode();
    }

    return true; // 已处理选择
},

// 更新选中数量显示
updateSelectionCount() {
    const selectedCount = document.getElementById('selected-count');
    if (selectedCount) {
        selectedCount.textContent = StateManager.selectedFiles.size;
    }
},

// 进入选择模式
enterSelectMode() {
    const selectBtn = DOMManager.elements.selectBtn;
    if (selectBtn) {
        selectBtn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
        selectBtn.title = '取消选择';
    }
    
    // 添加选择模式样式提示
    document.querySelectorAll('.file-item').forEach(item => {
        item.style.cursor = 'pointer';
    });
    
    DOMManager.showBatchToolbar();
    StateManager.clearSelectedFiles();
},

// 退出选择模式
exitSelectMode() {
    StateManager.clearSelectedFiles();
    DOMManager.hideBatchToolbar();
    
    // 移除所有选中状态
    document.querySelectorAll('.file-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    
    const selectBtn = DOMManager.elements.selectBtn;
    if (selectBtn) {
        selectBtn.innerHTML = '<i class="fas fa-check-square text-blue-500"></i>';
        selectBtn.title = '选择文件';
    }
    
    // 恢复默认样式
    document.querySelectorAll('.file-item').forEach(item => {
        item.style.cursor = '';
    });
},

// 切换选择模式
toggleSelectMode() {
    if (StateManager.selectedFiles.size > 0 || this.isInSelectMode()) {
        this.exitSelectMode();
    } else {
        this.enterSelectMode();
    }
},

// 检查是否在选择模式
isInSelectMode() {
    const selectBtn = DOMManager.elements.selectBtn;
    return selectBtn && selectBtn.innerHTML.includes('fa-times');
},

    // 下载选中的文件
    async downloadSelectedFiles() {
    if (StateManager.selectedFiles.size === 0) {
        ToastManager.show('请先选择文件');
        return;
    }

    // 单个文件直接下载
    if (StateManager.selectedFiles.size === 1) {
        const file = Array.from(StateManager.selectedFiles)[0];
        await FileManager.downloadFile(file);
        this.exitSelectMode();
        return;
    }

    // 多个文件打包下载
    try {
        ToastManager.show(`开始打包 ${StateManager.selectedFiles.size} 个文件...`);
        const zip = new JSZip();
        let count = 0;
        let errors = 0;

        // 创建进度提示
        const progressToast = ToastManager.createProgressToast(`打包中: 0/${StateManager.selectedFiles.size} 个文件`);

        // 下载所有选中的文件
        const downloadPromises = Array.from(StateManager.selectedFiles).map(async file => {
            if (file.type !== 'file' || !file.download_url) {
                errors++;
                return;
            }
            
            try {
                const response = await fetch(file.download_url);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const blob = await response.blob();
                
                // 构建文件路径，保持目录结构
                let filePath = file.name;
                if (file.path && file.path.includes('/')) {
                    // 如果文件有路径信息，保持路径结构
                    const pathParts = file.path.split('/');
                    pathParts.pop(); // 移除文件名
                    if (pathParts.length > 0) {
                        filePath = pathParts.join('/') + '/' + file.name;
                    }
                }
                
                zip.file(filePath, blob);
                count++;
                progressToast.textContent = `打包中: ${count}/${StateManager.selectedFiles.size} 个文件 (${errors} 失败)`;
            } catch (error) {
                console.error(`下载 ${file.name} 失败:`, error);
                errors++;
                progressToast.textContent = `打包中: ${count}/${StateManager.selectedFiles.size} 个文件 (${errors} 失败)`;
            }
        });

        // 等待所有下载完成
        await Promise.all(downloadPromises);
        
        if (count === 0) {
            ToastManager.show('没有文件可以下载');
            return;
        }
        
        // 生成ZIP文件
        const repoName = StateManager.currentRepo.split('/')[1] || 'download';
        const dateString = new Date().toISOString().slice(0,10);
        const zipFilename = `${repoName}-selected-files-${dateString}.zip`;
        
        const content = await zip.generateAsync({ type: 'blob' });
        
        // 创建下载链接
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = zipFilename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        // 清理
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }, 100);
        
        ToastManager.removeProgressToast();
        
        if (errors === 0) {
            ToastManager.show(`已成功打包下载 ${count} 个文件`);
        } else {
            ToastManager.show(`打包完成: ${count} 成功, ${errors} 失败`);
        }
    } catch (error) {
        console.error('打包下载失败:', error);
        ToastManager.show('打包下载失败: ' + error.message);
    } finally {
        this.exitSelectMode();
    }
},


    // 删除选中的文件
    async deleteSelectedFiles() {
        if (StateManager.selectedFiles.size === 0) {
            ToastManager.show('请先选择文件');
            return;
        }

        const files = Array.from(StateManager.selectedFiles);
        DialogManager.showConfirmDialog(
            '确认删除',
            `您确定要删除选中的 ${files.length} 个文件吗？此操作不可撤销。`,
            files
        );
    }
};

// ==================== 对话框管理模块 ====================
const DialogManager = {
    // 显示确认对话框
    showConfirmDialog(title, message, fileInfo) {
        const { confirmDialog, confirmTitle, confirmMessage } = DOMManager.elements;
        
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        StateManager.fileToDelete = fileInfo;
        
        confirmDialog.classList.add('opacity-100', 'pointer-events-auto');
        confirmDialog.querySelector('.dialog-content').classList.add('scale-100');
        confirmDialog.querySelector('.dialog-content').classList.remove('scale-90');
    },

    // 隐藏确认对话框
    hideConfirmDialog() {
        const { confirmDialog } = DOMManager.elements;
        
        confirmDialog.classList.remove('opacity-100', 'pointer-events-auto');
        confirmDialog.querySelector('.dialog-content').classList.add('scale-90');
        confirmDialog.querySelector('.dialog-content').classList.remove('scale-100');
        StateManager.fileToDelete = null;
    },

    // 显示新建文件夹对话框
    showNewFolderDialog() {
        const { newFolderDialog, newFolderName } = DOMManager.elements;
        
        newFolderName.value = '';
        newFolderDialog.classList.add('opacity-100', 'pointer-events-auto');
        newFolderDialog.querySelector('.dialog-content').classList.add('scale-100');
        newFolderDialog.querySelector('.dialog-content').classList.remove('scale-90');
        newFolderName.focus();
    },

    // 隐藏新建文件夹对话框
    hideNewFolderDialog() {
        const { newFolderDialog } = DOMManager.elements;
        
        newFolderDialog.classList.remove('opacity-100', 'pointer-events-auto');
        newFolderDialog.querySelector('.dialog-content').classList.add('scale-90');
        newFolderDialog.querySelector('.dialog-content').classList.remove('scale-100');
    },

    // 显示新建仓库对话框
    showNewRepoDialog() {
        const { newRepoDialog, newRepoName, newRepoDesc, newRepoPrivate } = DOMManager.elements;
        
        newRepoName.value = '';
        newRepoDesc.value = '';
        newRepoPrivate.checked = false;
        newRepoDialog.classList.add('opacity-100', 'pointer-events-auto');
        newRepoDialog.querySelector('.dialog-content').classList.add('scale-100');
        newRepoDialog.querySelector('.dialog-content').classList.remove('scale-90');
        newRepoName.focus();
    },

    // 隐藏新建仓库对话框
    hideNewRepoDialog() {
        const { newRepoDialog } = DOMManager.elements;
        
        newRepoDialog.classList.remove('opacity-100', 'pointer-events-auto');
        newRepoDialog.querySelector('.dialog-content').classList.add('scale-90');
        newRepoDialog.querySelector('.dialog-content').classList.remove('scale-100');
    },

    // 显示上传文件对话框
    showUploadDialog() {
        const { uploadDialog, fileInput } = DOMManager.elements;
        
        fileInput.value = '';
        uploadDialog.classList.add('opacity-100', 'pointer-events-auto');
        uploadDialog.querySelector('.dialog-content').classList.add('scale-100');
        uploadDialog.querySelector('.dialog-content').classList.remove('scale-90');
    },

    // 隐藏上传文件对话框
    hideUploadDialog() {
        const { uploadDialog } = DOMManager.elements;
        
        uploadDialog.classList.remove('opacity-100', 'pointer-events-auto');
        uploadDialog.querySelector('.dialog-content').classList.add('scale-90');
        uploadDialog.querySelector('.dialog-content').classList.remove('scale-100');
    },

    // 显示复刻仓库对话框
    showForkRepoDialog() {
        const { forkRepoDialog, forkRepoUrl } = DOMManager.elements;
        
        forkRepoUrl.value = '';
        forkRepoDialog.classList.add('opacity-100', 'pointer-events-auto');
        forkRepoDialog.querySelector('.dialog-content').classList.add('scale-100');
        forkRepoDialog.querySelector('.dialog-content').classList.remove('scale-90');
    },

    // 隐藏复刻仓库对话框
    hideForkRepoDialog() {
        const { forkRepoDialog } = DOMManager.elements;
        
        forkRepoDialog.classList.remove('opacity-100', 'pointer-events-auto');
        forkRepoDialog.querySelector('.dialog-content').classList.add('scale-90');
        forkRepoDialog.querySelector('.dialog-content').classList.remove('scale-100');
    },

    // 显示部署网站对话框
    showStaticSiteDialog() {
        const { staticSiteDialog, pagesBranch, pagesFolder, pagesStatus, staticSiteEnable } = DOMManager.elements;
        
        // 智能预填充设置
        pagesBranch.value = 'main';
        pagesFolder.value = '/';
        
        // 检查是否存在docs目录，如果存在则优先推荐
        const hasDocs = StateManager.currentFiles.some(file => 
            file.type === 'dir' && file.name.toLowerCase() === 'docs'
        );
        
        if (hasDocs) {
            pagesFolder.value = '/docs';
        }
        
        // 更新状态显示
        this.updatePagesStatusDisplay();
        
        staticSiteDialog.classList.add('opacity-100', 'pointer-events-auto');
        staticSiteDialog.querySelector('.dialog-content').classList.add('scale-100');
        staticSiteDialog.querySelector('.dialog-content').classList.remove('scale-90');
    },

    // 隐藏部署网站对话框
    hideStaticSiteDialog() {
        const { staticSiteDialog } = DOMManager.elements;
        
        staticSiteDialog.classList.remove('opacity-100', 'pointer-events-auto');
        staticSiteDialog.querySelector('.dialog-content').classList.add('scale-90');
        staticSiteDialog.querySelector('.dialog-content').classList.remove('scale-100');
    },

    // 更新Pages状态显示 - 修复版本
async updatePagesStatusDisplay() {
    const { pagesStatus, staticSiteEnable, pagesUrl, pagesBranch, pagesFolder } = DOMManager.elements;
    
    // 获取目标仓库
    const targetRepo = StateManager.contextMenuTarget ? 
        ContextMenuManager.getTargetRepo(StateManager.contextMenuTarget) : 
        StateManager.currentRepo;
        
    const isEnabled = StateManager.pagesEnabledMap.get(targetRepo) || false;
    
    if (isEnabled) {
        pagesStatus.classList.remove('hidden');
        staticSiteEnable.classList.add('hidden');
        
        try {
            const [owner, repoName] = targetRepo.split('/');
            const data = await APIService.getPagesStatus(owner, repoName);
            pagesUrl.href = data.html_url;
            pagesUrl.textContent = data.html_url;
            
            // 更新分支和目录显示
            pagesBranch.value = data.source.branch;
            pagesFolder.value = data.source.path === '/docs' ? '/docs' : '/';
        } catch (error) {
            console.error('获取Pages详情失败:', error);
        }
    } else {
        pagesStatus.classList.add('hidden');
        staticSiteEnable.classList.remove('hidden');
    }
},

    // 通用对话框隐藏函数
    hideDialog(dialogElement) {
        dialogElement.classList.remove('opacity-100', 'pointer-events-auto');
        dialogElement.querySelector('.dialog-content').classList.add('scale-90');
        dialogElement.querySelector('.dialog-content').classList.remove('scale-100');
    }
};

// ==================== 上下文菜单管理模块 ====================
const ContextMenuManager = {
    // 显示上下文菜单
    show(e, fileInfo) {
        e.preventDefault();
        
        // 创建遮罩层
        const mask = document.createElement('div');
        mask.id = 'context-menu-mask';
        mask.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 999;
        `;
        document.body.appendChild(mask);
        
        // 设置上下文菜单目标
        StateManager.contextMenuTarget = fileInfo;

        // 根据文件类型显示/隐藏菜单项
        this.updateMenuVisibility(fileInfo);
        
        // 定位菜单
        this.positionMenu(e);
        
        // 显示遮罩层
        mask.style.display = 'block';
        mask.addEventListener('click', this.hide);
        
        // 显示菜单
        const { contextMenu } = DOMManager.elements;
        contextMenu.classList.add('visible');
    },

   // 更新菜单项可见性
updateMenuVisibility(fileInfo) {
    const {
        contextOpen, contextDownload, contextRename,
        contextCopyLink, contextCopyProxyLink, contextDelete,
        contextDownloadSource, contextEnablePages, contextBuildApp,
        contextCopyRepoLink, contextCopySiteLink,
        // 新增：重命名仓库菜单项
        contextRenameRepo
    } = DOMManager.elements;
    contextOpen.style.display = fileInfo.type === 'dir' || fileInfo.type === 'repo' ? 'flex' : 'none';
    contextDownload.style.display = fileInfo.type === 'file' ? 'flex' : 'none';
    contextRename.style.display = fileInfo.type === 'file' || fileInfo.type === 'dir' ? 'flex' : 'none';
    contextCopyLink.style.display = fileInfo.type === 'file' ? 'flex' : 'none';
    contextCopyProxyLink.style.display = fileInfo.type === 'file' ? 'flex' : 'none';
    contextDelete.style.display = 'flex';
    contextDownloadSource.style.display = fileInfo.type === 'repo' ? 'flex' : 'none';
    
    // 仓库链接相关菜单项
    contextCopyRepoLink.style.display = fileInfo.type === 'repo' ? 'flex' : 'none';
    // 新增：重命名仓库菜单项（仅仓库显示）
    contextRenameRepo.style.display = fileInfo.type === 'repo' ? 'flex' : 'none';
    
    // 智能显示网站链接（仅当网站已部署时显示）
    if (fileInfo.type === 'repo' && fileInfo.pagesEnabled) {
        contextCopySiteLink.classList.remove('hidden');
    } else {
        contextCopySiteLink.classList.add('hidden');
    }
    
    // 智能显示Pages相关菜单项
    const isRepo = fileInfo.type === 'repo';
    const isRootDir = fileInfo.type === 'dir' && StateManager.currentPath === '';
    const isDocsDir = fileInfo.type === 'dir' && fileInfo.name.toLowerCase() === 'docs';
    
    const showPagesOption = isRepo || isRootDir || isDocsDir;
    contextEnablePages.style.display = showPagesOption ? 'flex' : 'none';
    
    if (showPagesOption) {
        this.updatePagesMenuButton(fileInfo);
    }
    
    contextBuildApp.style.display = fileInfo.type === 'repo' ? 'flex' : 'none';
},


    // 更新Pages菜单按钮
    async updatePagesMenuButton(fileInfo) {
        const { contextEnablePages } = DOMManager.elements;
        const targetRepo = this.getTargetRepo(fileInfo);
        
        // 检查Pages状态
        const isEnabled = await this.checkPagesStatus(targetRepo);
        
        if (isEnabled) {
            contextEnablePages.innerHTML = '<i class="fas fa-ban mr-2 text-red-500"></i><span class="text-red-500">禁用网站</span>';
        } else {
            contextEnablePages.innerHTML = '<i class="fas fa-globe mr-2 text-green-500"></i><span class="text-green-500">部署网站</span>';
        }
    },

    // 检查Pages状态
    async checkPagesStatus(repo) {
        // 如果有缓存，直接返回缓存值
        if (StateManager.pagesEnabledMap.has(repo)) {
            return StateManager.pagesEnabledMap.get(repo);
        }
        
        try {
            const [owner, repoName] = repo.split('/');
            const data = await APIService.getPagesStatus(owner, repoName);
            const isEnabled = (data.status === 'built' || data.status === 'building');
            StateManager.pagesEnabledMap.set(repo, isEnabled);
            return isEnabled;
        } catch (error) {
            console.error('检查Pages状态错误:', error);
            return false;
        }
    },

    // 获取目标仓库
    getTargetRepo(fileInfo) {
        if (fileInfo.type === 'repo') {
            return fileInfo.path;
        }
        return StateManager.currentRepo;
    },
    
    // 获取目标仓库的辅助方法
getTargetRepo(fileInfo) {
    if (fileInfo.type === 'repo') {
        return fileInfo.path;
    }
    return StateManager.currentRepo;
},

    // 定位菜单
    positionMenu(e) {
        const { contextMenu } = DOMManager.elements;
        const menuWidth = contextMenu.offsetWidth;
        const menuHeight = contextMenu.offsetHeight;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const triggerX = e.clientX;
        const triggerY = e.clientY;
        const spaceRight = viewportWidth - triggerX;
        const spaceLeft = triggerX;
        const spaceBelow = viewportHeight - triggerY;
        const spaceAbove = triggerY;
        
        // 默认位置（右下）
        let posX = triggerX;
        let posY = triggerY + 5;
        
        // 检查可用空间并调整位置
        if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
            posY = triggerY - menuHeight - 5;
        } else if (spaceBelow < menuHeight) {
            posY = viewportHeight - menuHeight - 10;
        }
        
        if (spaceRight < menuWidth && spaceLeft > menuWidth) {
            posX = triggerX - menuWidth - 5;
        } else if (spaceRight < menuWidth) {
            posX = viewportWidth - menuWidth - 10;
        }
        
        // 确保不会超出视口边界
        posX = Math.max(10, Math.min(posX, viewportWidth - menuWidth - 10));
        posY = Math.max(10, Math.min(posY, viewportHeight - menuHeight - 10));
        
        // 应用位置
        contextMenu.style.left = `${posX}px`;
        contextMenu.style.top = `${posY}px`;
    },

    // 隐藏上下文菜单
    hide() {
        const mask = document.getElementById('context-menu-mask');
        if (mask) {
            mask.remove();
        }
        
        const { contextMenu } = DOMManager.elements;
        contextMenu.classList.remove('visible');
        StateManager.contextMenuTarget = null;
        
        // 确保移除所有事件监听器
        document.removeEventListener('click', this.hide);
    },

    // 处理菜单项点击
handleMenuItemClick(action) {
    if (!StateManager.contextMenuTarget) return;
    
    switch (action) {
        case 'open':
            this.openContextItem(StateManager.contextMenuTarget);
            break;
        case 'download':
            FileManager.downloadFile(StateManager.contextMenuTarget);
            break;
        case 'rename':
            this.renameFile(StateManager.contextMenuTarget);
            break;
        case 'copy-link':
            this.copyFileLink(StateManager.contextMenuTarget, 'raw');
            break;
        case 'copy-proxy-link':
            this.copyFileLink(StateManager.contextMenuTarget, 'cdn');
            break;
        case 'copy-repo-link':  // 新增
            this.copyRepoLink(StateManager.contextMenuTarget);
            break;
        case 'copy-site-link':  // 新增
            this.copySiteLink(StateManager.contextMenuTarget);
            break;
        // 新增：重命名仓库处理
        case 'rename-repo':
            this.renameRepository(StateManager.contextMenuTarget);
            break;
        case 'delete':
            this.deleteContextItem(StateManager.contextMenuTarget);
            break;
        case 'download-source':
            this.downloadRepositorySource(StateManager.contextMenuTarget);
            break;
        case 'enable-pages':
            this.toggleGitHubPages(StateManager.contextMenuTarget);
            break;
        case 'build-app':
            this.buildApp(StateManager.contextMenuTarget);
            break;
    }
    
    this.hide();
},

// 复制仓库链接
copyRepoLink(repoInfo) {
    const repoUrl = `https://github.com/${repoInfo.path}`;
    this.copyToClipboard(repoUrl, '仓库链接已复制');
},

// 复制网站链接
copySiteLink(repoInfo) {
    const siteUrl = `https://${repoInfo.path.split('/')[0]}.github.io/${repoInfo.path.split('/')[1]}`;
    this.copyToClipboard(siteUrl, '网站链接已复制');
},

    // 打开上下文菜单项
    openContextItem(fileInfo) {
        if (fileInfo.type === 'dir') {
            NavigationManager.loadRepositoryContents(
                StateManager.currentRepo, 
                `${StateManager.currentPath ? StateManager.currentPath + '/' : ''}${fileInfo.name}`
            );
        } else if (fileInfo.type === 'repo') {
            NavigationManager.loadRepositoryContents(fileInfo.path);
        } else if (fileInfo.type === 'file' && fileInfo.download_url) {
            window.open(fileInfo.download_url, '_blank');
        }
    },

    // 重命名文件 
async renameFile(fileInfo) {
    try {
        console.log('开始重命名文件:', fileInfo);
        
        // 构建文件路径
        const filePath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${fileInfo.name}` : fileInfo.name;
        
        const encodedFilePath = encodeURIComponent(filePath);
        
        // 提示用户输入新文件名
        const newName = prompt('请输入新的文件名:', fileInfo.name);
        if (!newName || newName === fileInfo.name) return;
        
        if (!/^[a-zA-Z0-9_.-]+$/.test(newName)) {
            ToastManager.show('文件名只能包含字母、数字、下划线、点号和连字符');
            return;
        }

        // 构建新文件路径
        const newPath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${newName}` : newName;
        const encodedNewPath = encodeURIComponent(newPath);

        ToastManager.show('正在重命名文件...');

        // 步骤1: 获取原文件内容和SHA
        console.log('获取原文件信息...');
        const fileResponse = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodedFilePath}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );

        if (!fileResponse.ok) {
            const errorData = await fileResponse.json();
            throw new Error(errorData.message || `获取文件失败: ${fileResponse.status}`);
        }

        const fileData = await fileResponse.json();
        console.log('获取到文件SHA:', fileData.sha);

        // 步骤2: 创建新文件（使用原文件内容）
        console.log('创建新文件...');
        const createResponse = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodedNewPath}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Rename ${fileInfo.name} to ${newName}`,
                    content: fileData.content // 使用原文件的base64内容
                })
            }
        );

        if (!createResponse.ok) {
            const errorData = await createResponse.json();
            throw new Error(errorData.message || `创建新文件失败: ${createResponse.status}`);
        }

        // 步骤3: 删除原文件
        console.log('删除原文件...');
        const deleteResponse = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodedFilePath}`,
            {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Rename ${fileInfo.name} to ${newName}`,
                    sha: fileData.sha
                })
            }
        );

        if (!deleteResponse.ok) {
            const errorData = await deleteResponse.json();
            throw new Error(errorData.message || `删除原文件失败: ${deleteResponse.status}`);
        }

        ToastManager.show('文件重命名成功');
        
        // 刷新文件列表
        setTimeout(() => {
            NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        }, 1000);
        
    } catch (error) {
        console.error('重命名文件错误:', error);
        ToastManager.show('重命名文件失败: ' + error.message);
    }
},

      // 重命名仓库
async renameRepository(repoInfo) {
    try {
        const [owner, oldName] = repoInfo.path.split('/');
        const newName = prompt('请输入新的仓库名称:', oldName);
        
        if (!newName || newName === oldName) return;
        if (!/^[a-zA-Z0-9_.-]+$/.test(newName)) {
            ToastManager.show('仓库名称只能包含字母、数字、下划线、点号和连字符');
            return;
        }

        ToastManager.show('正在重命名仓库...');
        
        // 调用GitHub API重命名仓库
        const response = await fetch(
            `https://api.github.com/repos/${owner}/${oldName}`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName })
            }
        );

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '重命名失败');
        }

        ToastManager.show('仓库重命名成功');
        NavigationManager.loadRepositories(); // 刷新仓库列表
    } catch (error) {
        console.error('重命名仓库错误:', error);
        ToastManager.show('重命名失败: ' + error.message);
    }
},

    // 复制文件链接
copyFileLink(fileInfo, type) {
    if (fileInfo.type !== 'file') return;
    
    const [owner, repoName] = StateManager.currentRepo.split('/');
    const filePath = StateManager.currentPath ? 
        `${StateManager.currentPath}/${fileInfo.name}` : 
        fileInfo.name;
    
    let link;
    let successMessage;
    
    if (type === 'raw') {
        link = fileInfo.download_url;
        successMessage = 'Raw 链接已复制';
    } else {
        // 生成原始 raw URL
        const rawUrl = fileInfo.download_url || 
            fileInfo.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        
        // 使用 hub.gitmirror.com 代理（前缀方式）
        link = `https://gh-proxy.com/${rawUrl}`;
        successMessage = '代理链接已复制';
    }
    
    this.copyToClipboard(link, successMessage);
},

    // 复制到剪贴板
    copyToClipboard(text, successMessage) {
        // 创建隐藏的textarea元素
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = 0;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            // 尝试使用现代API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    ToastManager.show(successMessage);
                });
            } else {
                // 使用兼容性方法
                document.execCommand('copy');
                ToastManager.show(successMessage);
            }
        } catch (err) {
            console.error('复制失败:', err);
            ToastManager.show('复制失败: ' + err.message);
        } finally {
            // 清理
            document.body.removeChild(textArea);
        }
    },

    // 删除上下文菜单项
    deleteContextItem(fileInfo) {
        if (fileInfo.type === 'repo') {
            DialogManager.showConfirmDialog(
                '确认删除仓库',
                `您确定要删除仓库 "${fileInfo.name}" 吗？此操作不可撤销且会删除所有仓库内容。`,
                fileInfo
            );
        } else {
            DialogManager.showConfirmDialog(
                '确认删除',
                `您确定要删除 "${fileInfo.name}" 吗？此操作不可撤销。`,
                fileInfo
            );
        }
    },

    // 下载仓库源码
    async downloadRepositorySource(repoInfo) {
        try {
            ToastManager.show(`正在准备下载 ${repoInfo.name} 仓库...`);
            const [owner, repo] = repoInfo.path.split('/');

            // 获取仓库默认分支
            const repoData = await APIService.getRepositoryInfo(owner, repo);
            const defaultBranch = repoData.default_branch;
            
            // 尝试直接下载
            const directDownloadSuccess = await this.tryDirectDownload(owner, repo, defaultBranch);
            if (directDownloadSuccess) {
                ToastManager.show(`仓库 ${repoInfo.name} 下载完成`);
                return;
            }

            // 直接下载失败时使用API打包
            await this.downloadViaAPI(owner, repo, defaultBranch, repoInfo.name);
            
        } catch (error) {
            console.error('下载仓库失败:', error);
            ToastManager.show('下载失败: ' + error.message);
            ToastManager.removeProgressToast();
        }
    },

    // 尝试直接下载
    async tryDirectDownload(owner, repo, branch) {
        return new Promise((resolve) => {
            const testLink = document.createElement('a');
            testLink.href = `https://github.com/${owner}/${repo}/archive/refs/heads/${branch}.zip`;
            testLink.download = `${repo}-${branch}.zip`;
            
            // 设置超时检测（5秒）
            const timeoutId = setTimeout(() => {
                document.body.removeChild(testLink);
                resolve(false);
            }, 5000);
            
            testLink.onclick = () => {
                clearTimeout(timeoutId);
                testLink.onclick = null;
                setTimeout(() => {
                    document.body.removeChild(testLink);
                    resolve(true);
                }, 100);
            };
            
            document.body.appendChild(testLink);
            testLink.click();
        });
    },

    // API打包下载方法
    async downloadViaAPI(owner, repo, branch, repoName) {
        // 创建进度提示
        const progressToast = ToastManager.createProgressToast('正在准备打包仓库内容...');
        
        try {
            // 递归获取所有文件
            progressToast.textContent = '正在扫描仓库文件...';
            const allFiles = await this.getAllFilesRecursive(owner, repo, branch, '');
            
            if (allFiles.length === 0) throw new Error('仓库为空，无法下载');
            
            // 创建ZIP文件
            progressToast.textContent = `正在打包 ${allFiles.length} 个文件...`;
            const zip = new JSZip();
            const folder = zip.folder(`${repo}-${branch}`);
            
            let count = 0;
            const updateProgress = () => {
                progressToast.textContent = `打包进度: ${count}/${allFiles.length}`;
            };
            
            // 分批下载避免内存溢出
            const BATCH_SIZE = 10;
            for (let i = 0; i < allFiles.length; i += BATCH_SIZE) {
                const batch = allFiles.slice(i, i + BATCH_SIZE);
                await Promise.all(batch.map(async (file) => {
                    try {
                        const response = await fetch(file.download_url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const blob = await response.blob();
                        folder.file(file.path, blob);
                        count++;
                        updateProgress();
                    } catch (error) {
                        console.warn(`文件 ${file.path} 下载跳过:`, error);
                    }
                }));
            }

            // 生成ZIP文件
            progressToast.textContent = '正在生成压缩文件...';
            const content = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }, updateProgress);

            // 触发下载
            const date = new Date().toISOString().slice(0, 10);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${repo}-${branch}-${date}.zip`;
            link.click();
            
            // 清理资源
            setTimeout(() => {
                URL.revokeObjectURL(link.href);
                document.body.removeChild(link);
            }, 100);
            
            ToastManager.show(`仓库 ${repoName} 打包下载完成`);
        } finally {
            ToastManager.removeProgressToast();
        }
    },

    // 递归获取仓库文件
    async getAllFilesRecursive(owner, repo, branch, path) {
        try {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) return [];
            const items = await response.json();
            
            const files = [];
            for (const item of items) {
                if (item.type === 'file') {
                    files.push({
                        path: item.path,
                        download_url: item.download_url
                    });
                } else if (item.type === 'dir') {
                    const subFiles = await this.getAllFilesRecursive(owner, repo, branch, item.path);
                    files.push(...subFiles);
                }
            }
            return files;
        } catch (error) {
            console.error('获取文件列表错误:', error);
            return [];
        }
    },

    // 切换 GitHub Pages - 修复版本
async toggleGitHubPages(fileInfo) {
    const { contextEnablePages } = DOMManager.elements;
    const originalHTML = contextEnablePages.innerHTML;
    contextEnablePages.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>处理中...</span>';
    
    const targetRepo = this.getTargetRepo(fileInfo);
    const isEnabled = StateManager.pagesEnabledMap.get(targetRepo) || false;
    
    try {
        const [owner, repoName] = targetRepo.split('/');
        
        if (isEnabled) {
            // 禁用部署网站
            await APIService.disableGitHubPages(owner, repoName);
            StateManager.pagesEnabledMap.set(targetRepo, false);
            ToastManager.show('网站已禁用');
            
            // 隐藏上下文菜单
            this.hide();
            
            // 不需要刷新页面，只需更新状态
            setTimeout(() => {
                this.updatePagesMenuButton(fileInfo);
            }, 500);
            
        } else {
            // 启用部署网站 - 显示配置对话框
            this.hide(); // 先隐藏上下文菜单
            
            // 延迟显示对话框，避免菜单干扰
            setTimeout(() => {
                // 设置当前操作的仓库
                StateManager.contextMenuTarget = fileInfo;
                DialogManager.showStaticSiteDialog();
            }, 100);
        }
    } catch (error) {
        console.error('操作失败:', error);
        ToastManager.show(`操作失败: ${error.message}`);
        contextEnablePages.innerHTML = originalHTML;
    }
},

    // 构建应用
    async buildApp(repoInfo) {
        try {
            const [owner, repo] = repoInfo.path.split('/');
            
            // 显示构建状态
            const { buildStatus, buildIcon, buildMessage } = DOMManager.elements;
            buildStatus.classList.remove('hidden');
            buildIcon.className = 'fas fa-cog animate-spin text-blue-500 mr-2';
            buildMessage.textContent = '正在扫描工作流文件...';
            
            // 获取工作流文件列表
            const workflowsResponse = await fetch(
                `https://api.github.com/repos/${owner}/${repo}/contents/.github/workflows`,
                {
                    headers: {
                        'Authorization': `token ${StateManager.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );
            
            if (!workflowsResponse.ok) {
                throw new Error('获取工作流文件失败');
            }
            
            const workflowFiles = await workflowsResponse.json();
            const validWorkflows = workflowFiles.filter(file => 
                file.name.endsWith('.yml') || file.name.endsWith('.yaml')
            );
            
            if (validWorkflows.length === 0) {
                throw new Error('未找到工作流文件');
            }
            
            // 自动选择工作流
            let selectedWorkflow = validWorkflows.find(file => 
                file.name.toLowerCase().includes('build')
            ) || validWorkflows[0];
            
            const workflowFileName = selectedWorkflow.name;
            buildMessage.textContent = `找到工作流: ${workflowFileName}`;
            
            // 获取仓库默认分支
            const repoData = await APIService.getRepositoryInfo(owner, repo);
            const defaultBranch = repoData.default_branch;
            
            // 触发工作流
            await APIService.triggerWorkflow(owner, repo, workflowFileName, defaultBranch);
            
            buildMessage.textContent = `工作流 ${workflowFileName} 已触发！监控进度中...`;
            this.monitorBuildProgress(owner, repo);
        } catch (error) {
            console.error('构建APP错误:', error);
            const { buildIcon, buildMessage } = DOMManager.elements;
            buildIcon.className = 'fas fa-times-circle text-red-500 mr-2';
            buildMessage.textContent = '构建失败: ' + error.message;
        }
    },

    // 监控构建进度
    async monitorBuildProgress(owner, repo) {
        // 清除之前的定时器
        clearInterval(StateManager.buildTimer);
        
        // 设置进度条动画
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 95) {
                progress += 5;
                DOMManager.elements.progressBar.style.width = `${progress}%`;
                DOMManager.elements.progressText.textContent = `${progress}%`;
            }
        }, 2000);
        
        // 每10秒检查一次构建状态
        StateManager.buildTimer = setInterval(async () => {
            try {
                const data = await APIService.getWorkflowRuns(owner, repo);
                const latestRun = data.workflow_runs[0];
                
                if (!latestRun) {
                    return;
                }
                
                // 更新构建状态
                StateManager.buildStatus = latestRun.status;
                
                switch (latestRun.status) {
                    case 'completed':
                        clearInterval(progressInterval);
                        clearInterval(StateManager.buildTimer);
                        
                        if (latestRun.conclusion === 'success') {
                            DOMManager.elements.progressBar.style.width = '100%';
                            DOMManager.elements.progressText.textContent = '100%';
                            DOMManager.elements.buildIcon.className = 'fas fa-check-circle text-green-500 mr-2';
                            
                            // 获取制品信息
                            const artifactsResponse = await fetch(latestRun.artifacts_url, {
                                headers: {
                                    'Authorization': `token ${StateManager.githubToken}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (artifactsResponse.ok) {
                                const artifactsData = await artifactsResponse.json();
                                if (artifactsData.artifacts.length > 0) {
                                    const artifactLinks = artifactsData.artifacts.map(a => 
                                        `<a href="${a.archive_download_url}" target="_blank" class="text-blue-500">${a.name}</a>`
                                    ).join('<br>');
                                    
                                    DOMManager.elements.buildMessage.innerHTML = `构建成功！下载制品:<br>${artifactLinks}`;
                                } else {
                                    DOMManager.elements.buildMessage.innerHTML = '构建成功！<br>可在仓库的Actions页面查看详情';
                                }
                            } else {
                                DOMManager.elements.buildMessage.innerHTML = '构建成功！<br>可在仓库的Actions页面查看详情';
                            }
                        } else {
                            DOMManager.elements.buildIcon.className = 'fas fa-times-circle text-red-500 mr-2';
                            DOMManager.elements.buildMessage.textContent = `构建失败: ${latestRun.conclusion}`;
                        }
                        break;
                        
                    case 'in_progress':
                        DOMManager.elements.buildMessage.textContent = '构建正在进行中...';
                        break;
                        
                    case 'queued':
                        DOMManager.elements.buildMessage.textContent = '构建任务排队中...';
                        break;
                }
            } catch (error) {
                console.error('监控构建进度错误:', error);
                clearInterval(progressInterval);
                clearInterval(StateManager.buildTimer);
                DOMManager.elements.buildIcon.className = 'fas fa-times-circle text-red-500 mr-2';
                DOMManager.elements.buildMessage.textContent = '监控失败: ' + error.message;
            }
        }, 10000);
    }
};

// ==================== 认证管理模块 ====================
const AuthManager = {
    // 验证 Token
    async verifyToken(token) {
        try {
            // 显示加载状态
            const { authBtnText, authSpinner, authBtn } = DOMManager.elements;
            authBtnText.textContent = '认证中...';
            authSpinner.classList.remove('hidden');
            authBtn.disabled = true;
            
            // 设置超时
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            // 发送验证请求
            const userData = await APIService.verifyToken(token);
            
            clearTimeout(timeoutId);
            
            // 认证成功
            StateManager.setToken(token);
            StateManager.currentUser = userData;
            
            ToastManager.show(`欢迎: ${userData.login || '用户'}！`);
            DOMManager.showMainScreen();
            
            // 更新用户信息
            DOMManager.elements.username.textContent = userData.login;
            
            // 认证成功后初始化页面状态
            App.initializePageState();
            
        } catch (error) {
            console.error('认证错误:', error);
            
            let errorMessage = error.message;
            if (error.name === 'AbortError') {
                errorMessage = '请求超时，请检查网络连接';
            }
            
            this.showTokenError(errorMessage);
            ToastManager.show(errorMessage);
            
        } finally {            
            const { authBtnText, authSpinner, authBtn } = DOMManager.elements;
            authBtnText.textContent = '认证并继续';
            authSpinner.classList.add('hidden');
            authBtn.disabled = false;
        }
    },

    // 显示 Token 错误
    showTokenError(message) {
        const { tokenError } = DOMManager.elements;
        tokenError.textContent = message;
        tokenError.classList.remove('hidden');
    },

    // 退出登录
    logout() {
        StateManager.clearToken();
        StateManager.currentUser = null;
        DOMManager.showAuthScreen();
        const { githubTokenInput, tokenError } = DOMManager.elements;
        githubTokenInput.value = '';
        tokenError.classList.add('hidden');
        ToastManager.show('已退出登录');
    },

    // 检查本地存储中的 Token
    checkStoredToken() {
        const savedToken = localStorage.getItem('github_token');
        if (savedToken) {
            StateManager.githubToken = savedToken;
            DOMManager.elements.githubTokenInput.value = '********';
            this.verifyToken(savedToken);
        }
    }
};

// ==================== 提示管理模块 ====================
const ToastManager = {
    // 显示提示
    show(message) {
        const { toast } = DOMManager.elements;
        if (!toast) return;
        
        toast.textContent = message;
        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');
        
        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 3000);
    },

    // 创建进度提示
    createProgressToast(text) {
        this.removeProgressToast();
        
        const toast = document.createElement('div');
        toast.id = 'progress-toast';
        toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full text-sm font-medium';
        toast.textContent = text;
        document.body.appendChild(toast);
        return toast;
    },

    // 移除进度提示
    removeProgressToast() {
        const existing = document.getElementById('progress-toast');
        if (existing) document.body.removeChild(existing);
    }
};

// ==================== 应用主模块 ====================
const App = {
    // 初始化应用
    init() {
        // 初始化DOM引用
        DOMManager.init();
        
        // 检查本地存储的Token
        AuthManager.checkStoredToken();
        
        // 绑定事件监听器
        this.bindEventListeners();
        
        // 添加浏览器历史记录监听
        window.addEventListener('popstate', (event) => {
            NavigationManager.handlePopState(event);
        });
        
        // 初始化页面状态 - 确保在认证完成后调用
        if (StateManager.githubToken) {
            this.initializePageState();
        }
        
        // 预加载Monaco Editor
        if (StateManager.githubToken) {
            EditorManager.init().catch(e => {
                console.log('Monaco预加载失败:', e);
            });
        }
    },

// 初始化页面状态
initializePageState() {
    // 延迟执行以确保DOM完全加载
    setTimeout(() => {
        const state = NavigationManager.parseURL();
        NavigationManager.navigateToState(state.type, state.data);
    }, 100);
},

    // 绑定事件监听器 - 移除返回按钮事件
    bindEventListeners() {
        const {
            authBtn, githubTokenInput, refreshBtn,
            newRepoBtn, forkRepoBtn, newFolderBtn, uploadBtn,
            selectBtn, staticSiteBtn, userMenuBtn, logoutBtn,
            batchDownloadBtn, batchDeleteBtn, batchCancelBtn,
            editorSaveBtn, editorCloseBtn, confirmYes, confirmNo,
            newFolderCreate, newFolderCancel, newRepoCreate, newRepoCancel,
            uploadFile, uploadCancel, staticSiteEnable, staticSiteCancel,
            forkRepoConfirm, forkRepoCancel, mobileSaveBtn, mobileCloseBtn,
            mobileUndoBtn, mobileRedoBtn, mobileSearchBtn, closeBuildStatus
        } = DOMManager.elements;

        // 认证相关
        authBtn?.addEventListener('click', () => {
            const token = githubTokenInput.value.trim();
            if (!token) {
                AuthManager.showTokenError('请输入 GitHub Token');
                return;
            }
            if (token.length !== 40) {
                AuthManager.showTokenError('Token 应为 40 位字符');
                return;
            }
            AuthManager.verifyToken(token);
        });

        // 导航相关
        refreshBtn?.addEventListener('click', () => {
            if (StateManager.currentRepo) {
                NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
            } else {
                NavigationManager.loadRepositories();
            }
        });

        // 工具栏按钮
        newRepoBtn?.addEventListener('click', () => DialogManager.showNewRepoDialog());
        forkRepoBtn?.addEventListener('click', () => DialogManager.showForkRepoDialog());
        newFolderBtn?.addEventListener('click', () => DialogManager.showNewFolderDialog());
        uploadBtn?.addEventListener('click', () => DialogManager.showUploadDialog());
        selectBtn?.addEventListener('click', () => SelectionManager.toggleSelectMode());
        staticSiteBtn?.addEventListener('click', () => DialogManager.showStaticSiteDialog());

        // 用户菜单
        userMenuBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            DOMManager.elements.userMenuContent.classList.toggle('show');
        });
        
        logoutBtn?.addEventListener('click', () => AuthManager.logout());
        
        // 点击其他地方隐藏用户菜单
        document.addEventListener('click', () => {
            DOMManager.elements.userMenuContent?.classList.remove('show');
        });

        // 批量操作
        batchDownloadBtn?.addEventListener('click', () => SelectionManager.downloadSelectedFiles());
        batchDeleteBtn?.addEventListener('click', () => SelectionManager.deleteSelectedFiles());
        batchCancelBtn?.addEventListener('click', () => SelectionManager.exitSelectMode());

        // 编辑器
        editorSaveBtn?.addEventListener('click', () => EditorManager.saveFileChanges());
        editorCloseBtn?.addEventListener('click', () => EditorManager.closeEditor());

        // 移动设备工具栏
        mobileSaveBtn?.addEventListener('click', () => EditorManager.saveFileChanges());
        mobileCloseBtn?.addEventListener('click', () => EditorManager.closeEditor());
        mobileUndoBtn?.addEventListener('click', () => {
            if (StateManager.editor) StateManager.editor.getModel().undo();
        });
        mobileRedoBtn?.addEventListener('click', () => {
            if (StateManager.editor) StateManager.editor.getModel().redo();
        });
        mobileSearchBtn?.addEventListener('click', () => {
            if (StateManager.editor) {
                StateManager.editor.focus();
                StateManager.editor.trigger('', 'actions.find');
            }
        });

        // 确认对话框
        confirmYes?.addEventListener('click', () => this.handleConfirmYes());
        confirmNo?.addEventListener('click', () => DialogManager.hideConfirmDialog());

        // 新建文件夹对话框
        newFolderCreate?.addEventListener('click', () => this.handleNewFolderCreate());
        newFolderCancel?.addEventListener('click', () => DialogManager.hideNewFolderDialog());

        // 新建仓库对话框
        newRepoCreate?.addEventListener('click', () => this.handleNewRepoCreate());
        newRepoCancel?.addEventListener('click', () => DialogManager.hideNewRepoDialog());

        // 上传文件对话框
        uploadFile?.addEventListener('click', () => this.handleFileUpload());
        uploadCancel?.addEventListener('click', () => DialogManager.hideUploadDialog());

        // 部署网站对话框
        staticSiteEnable?.addEventListener('click', () => this.enableGitHubPages());
        staticSiteCancel?.addEventListener('click', () => DialogManager.hideStaticSiteDialog());

        // 复刻仓库对话框
        forkRepoConfirm?.addEventListener('click', () => this.handleForkRepo());
        forkRepoCancel?.addEventListener('click', () => DialogManager.hideForkRepoDialog());

        // 构建状态
        closeBuildStatus?.addEventListener('click', () => this.closeBuildStatus());

        // 上下文菜单
        this.bindContextMenuEvents();

        // 对话框遮罩层点击事件
        this.bindDialogMaskEvents();
    },

   
// 绑定上下文菜单事件
bindContextMenuEvents() {
    const {
        contextOpen, contextDownload, contextRename,
        contextCopyLink, contextCopyProxyLink, contextDelete,
        contextEnablePages, contextBuildApp, contextDownloadSource,
        contextCopyRepoLink, contextCopySiteLink,
        // 新增：重命名仓库菜单项
        contextRenameRepo
    } = DOMManager.elements;
    contextOpen?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('open'));
    contextDownload?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('download'));
    contextRename?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('rename'));
    contextCopyLink?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('copy-link'));
    contextCopyProxyLink?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('copy-proxy-link'));
    contextCopyRepoLink?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('copy-repo-link'));
    contextCopySiteLink?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('copy-site-link'));
    // 新增：重命名仓库菜单项点击事件
    contextRenameRepo?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('rename-repo'));
    contextDelete?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('delete'));
    contextDownloadSource?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('download-source'));
    contextEnablePages?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('enable-pages'));
    contextBuildApp?.addEventListener('click', () => ContextMenuManager.handleMenuItemClick('build-app'));
    // 点击其他地方隐藏上下文菜单
    document.addEventListener('click', () => ContextMenuManager.hide());
},

    // 绑定对话框遮罩层事件
    bindDialogMaskEvents() {
        const dialogs = [
            'confirm-dialog', 'new-folder-dialog', 'new-repo-dialog',
            'fork-repo-dialog', 'upload-dialog', 'static-site-dialog'
        ];

        dialogs.forEach(dialogId => {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        DialogManager.hideDialog(dialog);
                    }
                });
            }
        });
    },

    // 处理确认对话框的确认操作
    async handleConfirmYes() {
        if (StateManager.fileToDelete) {
            if (Array.isArray(StateManager.fileToDelete)) {
                await this.deleteFiles(StateManager.fileToDelete);
            } else if (StateManager.fileToDelete.type === 'repo') {
                await this.deleteRepository(StateManager.fileToDelete);
            } else {
                await this.deleteFile(StateManager.fileToDelete);
            }
        }
        DialogManager.hideConfirmDialog();
    },

   // 删除文件或文件夹 - 修复版本
async deleteFile(fileInfo) {
    try {
        // 如果是文件夹，需要递归删除
        if (fileInfo.type === 'dir') {
            await this.deleteFolderRecursive(fileInfo);
            return;
        }

        // 以下是原有的文件删除逻辑
        const filePath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${fileInfo.name}` : fileInfo.name;
        
        // 获取文件SHA
        const fileData = await this.getFileInfoIfExists(filePath);
        
        if (!fileData || !fileData.sha) {
            throw new Error('无法获取文件SHA，文件可能不存在');
        }

        // 删除文件
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${fileInfo.name}`,
                    sha: fileData.sha
                })
            }
        );

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `删除失败: ${response.status}`);
        }

        ToastManager.show('文件删除成功');
        NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        
    } catch (error) {
        console.error('删除文件错误:', error);
        ToastManager.show('删除文件失败: ' + error.message);
    }
},

// 新增：递归删除文件夹
async deleteFolderRecursive(folderInfo) {
    try {
        ToastManager.show(`正在删除文件夹 ${folderInfo.name}...`);
        
        // 获取文件夹内容
        const folderPath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${folderInfo.name}` : folderInfo.name;
        
        const contents = await APIService.getRepositoryContents(StateManager.currentRepo, folderPath);
        
        if (contents.length === 0) {
            // 空文件夹，删除 .gitkeep 文件（如果存在）
            await this.deleteGitKeepFile(folderPath);
            ToastManager.show('空文件夹删除成功');
            NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
            return;
        }

        // 递归删除所有内容
        let successCount = 0;
        let failCount = 0;

        for (const item of contents) {
            try {
                // 构建完整路径
                const fullPath = `${folderPath}/${item.name}`;
                
                if (item.type === 'dir') {
                    // 递归删除子文件夹
                    await this.deleteFolderRecursive({
                        ...item,
                        name: fullPath.split('/').pop()
                    });
                } else {
                    // 删除文件
                    await this.deleteFileInPath(fullPath, item.name);
                }
                successCount++;
            } catch (error) {
                console.error(`删除 ${item.name} 失败:`, error);
                failCount++;
            }
        }

        // 最后删除文件夹本身（通过删除.gitkeep文件）
        await this.deleteGitKeepFile(folderPath);

        if (failCount === 0) {
            ToastManager.show(`文件夹 ${folderInfo.name} 删除成功`);
        } else {
            ToastManager.show(`文件夹删除完成: ${successCount} 成功, ${failCount} 失败`);
        }

        NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        
    } catch (error) {
        console.error('删除文件夹错误:', error);
        throw error;
    }
},

// 新增：删除路径中的文件
async deleteFileInPath(filePath, fileName) {
    const fileData = await this.getFileInfoIfExists(filePath);
    
    if (!fileData || !fileData.sha) {
        throw new Error(`无法获取文件SHA: ${fileName}`);
    }

    const response = await fetch(
        `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
        {
            method: 'DELETE',
            headers: {
                'Authorization': `token ${StateManager.githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Delete ${fileName}`,
                sha: fileData.sha
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `删除失败: ${response.status}`);
    }
},

// 新增：删除.gitkeep文件（用于标记空文件夹）
async deleteGitKeepFile(folderPath) {
    const gitkeepPath = `${folderPath}/.gitkeep`;
    
    try {
        const gitkeepData = await this.getFileInfoIfExists(gitkeepPath);
        if (gitkeepData && gitkeepData.sha) {
            await this.deleteFileInPath(gitkeepPath, '.gitkeep');
        }
    } catch (error) {
        // .gitkeep文件不存在是正常的，忽略错误
        console.log('.gitkeep文件不存在，跳过删除');
    }
},

    // 批量删除文件 - 修复版本
async deleteFiles(files) {
    try {
        let successCount = 0;
        let failCount = 0;
        
        for (const file of files) {
            try {
                if (file.type === 'dir') {
                    // 递归删除文件夹
                    await this.deleteFolderRecursive(file);
                } else {
                    // 删除文件
                    const filePath = StateManager.currentPath ? 
                        `${StateManager.currentPath}/${file.name}` : file.name;
                    
                    const fileData = await this.getFileInfoIfExists(filePath);
                    
                    if (!fileData || !fileData.sha) {
                        console.warn(`文件 ${file.name} 不存在，跳过删除`);
                        failCount++;
                        continue;
                    }

                    await this.deleteFileInPath(filePath, file.name);
                }
                successCount++;
            } catch (error) {
                console.error(`删除 ${file.name} 失败:`, error);
                failCount++;
            }
        }
        
        if (failCount === 0) {
            ToastManager.show(`成功删除 ${successCount} 个项目`);
        } else {
            ToastManager.show(`删除完成: ${successCount} 成功, ${failCount} 失败`);
        }
        
        SelectionManager.exitSelectMode();
        NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        
    } catch (error) {
        console.error('批量删除错误:', error);
        ToastManager.show('批量删除失败: ' + error.message);
    }
},

    // 删除仓库
    async deleteRepository(repoInfo) {
        try {
            const [owner, repoName] = repoInfo.path.split('/');
            
            await APIService.deleteRepository(owner, repoName);
            
            ToastManager.show('仓库删除成功');
            NavigationManager.loadRepositories();
            
        } catch (error) {
            console.error('删除仓库错误:', error);
            ToastManager.show('删除仓库失败: ' + error.message);
        }
    },

    // 处理新建文件夹 - 修复版本
async handleNewFolderCreate() {
    const folderNameInput = DOMManager.elements.newFolderName;
    const folderName = folderNameInput.value.trim();
    
    if (!folderName) {
        ToastManager.show('请输入文件夹名称');
        folderNameInput.focus();
        return;
    }

    // 验证文件夹名称格式
    if (!/^[a-zA-Z0-9_.-]+$/.test(folderName)) {
        ToastManager.show('文件夹名称只能包含字母、数字、下划线、点号和连字符');
        folderNameInput.focus();
        return;
    }

    try {
        // 显示创建中状态
        const createBtn = DOMManager.elements.newFolderCreate;
        const originalText = createBtn.innerHTML;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';
        createBtn.disabled = true;

        await this.createFolder(folderName);
        DialogManager.hideNewFolderDialog();
        
    } catch (error) {
        console.error('处理新建文件夹错误:', error);
        // 错误已经在 createFolder 中处理，这里不需要重复处理
    } finally {
        // 恢复按钮状态
        const createBtn = DOMManager.elements.newFolderCreate;
        createBtn.innerHTML = '创建';
        createBtn.disabled = false;
    }
},

    // 创建文件夹 - 修复版本
async createFolder(folderName) {
    try {
        // 验证文件夹名称
        if (!folderName || folderName.trim() === '') {
            throw new Error('文件夹名称不能为空');
        }

        // 清理文件夹名称
        folderName = folderName.trim().replace(/[\/\\]/g, '');
        
        // 构建文件路径
        const filePath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${folderName}/.gitkeep` : `${folderName}/.gitkeep`;
        
        console.log('创建文件夹:', {
            repo: StateManager.currentRepo,
            path: filePath,
            token: StateManager.githubToken ? '有Token' : '无Token'
        });

        // 直接使用 fetch 确保认证头正确传递
        const base64Content = btoa(unescape(encodeURIComponent(''))); // 空内容
        
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Create folder ${folderName}`,
                    content: base64Content
                })
            }
        );

        console.log('API响应状态:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('API错误详情:', errorData);
            
            if (response.status === 401) {
                throw new Error('认证失败: Token 无效或已过期，请重新登录');
            } else if (response.status === 403) {
                throw new Error('权限不足: Token 缺少 repo 权限或已达到 API 限制');
            } else if (response.status === 404) {
                throw new Error('仓库不存在或没有访问权限');
            } else if (response.status === 422) {
                // 文件已存在的情况
                if (errorData.message && errorData.message.includes('already exists')) {
                    throw new Error(`文件夹 "${folderName}" 已存在`);
                }
                throw new Error(errorData.message || '创建失败: 验证错误');
            } else {
                throw new Error(errorData.message || `创建失败: ${response.status}`);
            }
        }

        const result = await response.json();
        console.log('创建成功:', result);
        
        ToastManager.show(`文件夹 "${folderName}" 创建成功`);
        
        // 刷新文件列表
        setTimeout(() => {
            NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
        }, 500);
        
    } catch (error) {
        console.error('创建文件夹错误:', error);
        
        // 更详细的错误处理
        if (error.message.includes('认证失败') || error.message.includes('权限不足')) {
            ToastManager.show(error.message);
            // 如果是认证问题，建议重新登录
            setTimeout(() => {
                if (confirm('认证失败，是否重新登录？')) {
                    AuthManager.logout();
                }
            }, 1000);
        } else {
            ToastManager.show('创建文件夹失败: ' + error.message);
        }
    }
},

// 创建仓库方法 - 简化版本
createRepository: async function(name, description, isPrivate) {
    try {
        ToastManager.show('正在创建仓库...');

        // 使用 APIService 创建仓库
        const result = await APIService.createRepository(name, description, isPrivate);
        
        ToastManager.show(`仓库 "${name}" 创建成功`);
        
        // 刷新仓库列表
        NavigationManager.loadRepositories();
        
        return result;
    } catch (error) {
        console.error('创建仓库错误:', error);
        ToastManager.show('创建仓库失败: ' + error.message);
        throw error;
    }
},

    // 处理新建仓库 - 修复版本
async handleNewRepoCreate() {
    const repoName = DOMManager.elements.newRepoName.value.trim();
    const repoDesc = DOMManager.elements.newRepoDesc.value.trim();
    const isPrivate = DOMManager.elements.newRepoPrivate.checked;
    
    if (!repoName) {
        ToastManager.show('请输入仓库名称');
        DOMManager.elements.newRepoName.focus();
        return;
    }

    // 验证仓库名称格式
    if (!/^[a-zA-Z0-9_.-]+$/.test(repoName)) {
        ToastManager.show('仓库名称只能包含字母、数字、下划线、点号和连字符');
        DOMManager.elements.newRepoName.focus();
        return;
    }

    try {
        // 显示创建中状态
        const createBtn = DOMManager.elements.newRepoCreate;
        const originalText = createBtn.innerHTML;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';
        createBtn.disabled = true;

        // 调用 createRepository 方法
        await this.createRepository(repoName, repoDesc, isPrivate);
        DialogManager.hideNewRepoDialog();
        
    } catch (error) {
        console.error('处理新建仓库错误:', error);
        // 错误已经在 createRepository 中处理，这里不需要重复处理
    } finally {
        // 恢复按钮状态
        const createBtn = DOMManager.elements.newRepoCreate;
        createBtn.innerHTML = '创建';
        createBtn.disabled = false;
    }
},

    // 处理文件上传 - 添加文件大小限制
async handleFileUpload() {
    if (!DOMManager.elements.fileInput.files || DOMManager.elements.fileInput.files.length === 0) {
        ToastManager.show('请先选择文件');
        return;
    }

    try {
        const files = Array.from(DOMManager.elements.fileInput.files);
        
        // 检查文件大小 (GitHub限制单个文件最大100MB)
        const oversizedFiles = files.filter(file => file.size > 100 * 1024 * 1024);
        if (oversizedFiles.length > 0) {
            ToastManager.show(`文件 ${oversizedFiles[0].name} 超过100MB限制`);
            return;
        }

        let successfulUploads = 0;
        let failedUploads = 0;
        
        // 显示上传进度
        const progressToast = ToastManager.createProgressToast(`准备上传 ${files.length} 个文件...`);
        DialogManager.hideUploadDialog();

        // 顺序上传每个文件
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            try {
                progressToast.textContent = `正在上传 ${i+1}/${files.length}: ${file.name}...`;
                
                await this.uploadSingleFile(file);
                successfulUploads++;
                
                // 小延迟避免速率限制
                if (i < files.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            } catch (error) {
                console.error(`文件 ${file.name} 上传失败:`, error);
                failedUploads++;
                
                // 如果是速率限制错误，等待一段时间再继续
                if (error.message.includes('API rate limit')) {
                    progressToast.textContent = `遇到速率限制，等待60秒后继续...`;
                    await new Promise(resolve => setTimeout(resolve, 60000));
                    i--; // 重试当前文件
                    continue;
                }
            }
        }

        ToastManager.removeProgressToast();
        
        if (failedUploads === 0) {
            ToastManager.show(`成功上传 ${successfulUploads} 个文件`);
        } else {
            ToastManager.show(`上传完成: ${successfulUploads} 成功, ${failedUploads} 失败`);
        }

        NavigationManager.loadRepositoryContents(StateManager.currentRepo, StateManager.currentPath);
    } catch (error) {
        console.error('上传过程中发生错误:', error);
        ToastManager.show('上传过程中发生错误: ' + error.message);
    } finally {
        DOMManager.elements.fileInput.value = '';
    }
},


    // 上传单个文件 - 修复版本
async uploadSingleFile(file) {
    try {
        // 1. 读取文件内容为Base64 - 使用更可靠的方法
        const base64Content = await this.readFileAsBase64(file);
        
        // 2. 构建文件路径
        const filePath = StateManager.currentPath ? 
            `${StateManager.currentPath}/${file.name}` : file.name;
        
        // 3. 检查文件是否存在并获取SHA - 使用新的检查方法
        const fileInfo = await this.getFileInfoIfExists(filePath);
        
        // 4. 构建上传数据
        const uploadData = {
            message: `Upload ${file.name}`,
            content: base64Content
        };
        
        // 如果文件已存在，添加SHA用于更新
        if (fileInfo && fileInfo.sha) {
            uploadData.sha = fileInfo.sha;
        }
        
        // 5. 执行上传
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            }
        );

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `上传失败: ${response.status}`);
        }

        return { file: file.name, status: 'success' };
    } catch (error) {
        console.error(`文件 ${file.name} 上传失败:`, error);
        throw error;
    }
},

// 检查文件是否存在并返回文件信息
async getFileInfoIfExists(filePath) {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${StateManager.currentRepo}/contents/${encodeURIComponent(filePath)}`,
            {
                headers: {
                    'Authorization': `token ${StateManager.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            return { sha: data.sha, exists: true };
        } else if (response.status === 404) {
            return null; // 文件不存在
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || '检查文件状态失败');
        }
    } catch (error) {
        console.error('检查文件存在性错误:', error);
        return null;
    }
},

// 可靠的文件读取为Base64
readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            // 将ArrayBuffer转换为base64
            const arrayBuffer = reader.result;
            const uint8Array = new Uint8Array(arrayBuffer);
            let binaryString = '';
            uint8Array.forEach(byte => {
                binaryString += String.fromCharCode(byte);
            });
            resolve(btoa(binaryString));
        };
        reader.onerror = () => reject(new Error('文件读取失败'));
        reader.readAsArrayBuffer(file);
    });
},

    // 启用 GitHub Pages
async enableGitHubPages() {
    const enableBtn = DOMManager.elements.staticSiteEnable;
    const originalText = enableBtn.innerHTML;
    
    try {
        // 显示加载状态
        enableBtn.disabled = true;
        enableBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        
        // 获取目标仓库
        const targetRepo = StateManager.contextMenuTarget ? 
            ContextMenuManager.getTargetRepo(StateManager.contextMenuTarget) : 
            StateManager.currentRepo;
            
        const [owner, repoName] = targetRepo.split('/');
        const branch = DOMManager.elements.pagesBranch.value;
        const path = DOMManager.elements.pagesFolder.value === '/docs' ? '/docs' : '/';
        
        console.log('启用 Pages 参数:', { owner, repoName, branch, path });
        
       
        await APIService.enableGitHubPages(owner, repoName, branch, path);
        
        // 更新状态映射
        StateManager.pagesEnabledMap.set(targetRepo, true);
        
        ToastManager.show(`网站已部署: ${targetRepo}`);
        DialogManager.hideStaticSiteDialog();
        
        // 更新菜单按钮状态
        if (StateManager.contextMenuTarget) {
            setTimeout(() => {
                ContextMenuManager.updatePagesMenuButton(StateManager.contextMenuTarget);
            }, 1000);
        }
        
        // 清除上下文菜单目标
        StateManager.contextMenuTarget = null;
        
    } catch (error) {
        console.error('部署网站错误:', error);
        ToastManager.show('操作失败: ' + error.message);
        
        // 恢复按钮状态
        enableBtn.disabled = false;
        enableBtn.innerHTML = originalText;
    }
},

    // 处理复刻仓库
    async handleForkRepo() {
        const repoUrl = DOMManager.elements.forkRepoUrl.value.trim();
        if (repoUrl) {
            await this.forkRepository(repoUrl);
        } else {
            ToastManager.show('请输入GitHub仓库URL');
        }
    },

    // 复刻仓库
    async forkRepository(repoUrl) {
        try {
            // 从URL中提取owner和repo名称
            const urlPattern = /https:\/\/github\.com\/([^\/]+)\/([^\/]+)/i;
            const match = repoUrl.match(urlPattern);
            
            if (!match || match.length < 3) {
                throw new Error('无效的GitHub仓库URL');
            }
            
            const owner = match[1];
            const repo = match[2];
            
            ToastManager.show('正在复刻仓库...');
            DialogManager.hideForkRepoDialog();
            
            await APIService.forkRepository(owner, repo);
                    
            ToastManager.show('仓库复刻中，请稍后刷新查看...');
            
            // 8秒后自动刷新
            setTimeout(() => {
                NavigationManager.loadRepositories();
            }, 8000);
            
        } catch (error) {
            console.error('复刻仓库错误:', error);
            ToastManager.show('复刻仓库失败: ' + error.message);
        }
    },

    // 关闭构建状态
    closeBuildStatus() {
        DOMManager.elements.buildStatus.classList.add('hidden');
        clearInterval(StateManager.buildTimer);
        StateManager.buildStatus = null;
    }
};

// 初始化应用
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});
    </script>
</body>
</html>